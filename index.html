<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stundenkonto Monatsübersicht</title>
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF-AutoTable Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
             --primary-color: #0056b3; --secondary-color: #6c757d; --success-color: #28a745;
             --warning-color: #fd7e14; --danger-color: #dc3545; --frueh-color: #800020;
             /* Color for M1 changed to turquoise */
             --m1-color: #17a2b8; /* Turquoise */
             --positive-color: var(--success-color); --light-gray: #f8f9fa; --medium-gray: #e9ecef;
             --dark-gray: #adb5bd; --border-color: #dee2e6; --text-color: #212529;
             --text-muted: #6c757d; --link-color: #007bff; --focus-ring-color: rgba(0, 123, 255, 0.25);
             --weekend-bg: #f1f3f5;
             --holiday-border: 2px solid var(--danger-color);
             --half-holiday-border: 2px dashed var(--warning-color); /* Style for half holidays */
             --selected-outline: 2px solid var(--link-color);
             /* Removed disclaimer variables */
         }

        *, *::before, *::after { box-sizing: border-box; }

        body {
             font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji';
             line-height: 1.6; margin: 0; padding: 8px;
             background-color: var(--light-gray); color: var(--text-color); font-size: 14px;
             -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
         }
        .container {
             max-width: 950px; margin: 10px auto; padding: 15px;
             background-color: #ffffff;
             border-radius: 8px;
             box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
         }
        h1 {
             color: #343a40; text-align: center; margin-top: 0; margin-bottom: 15px; font-size: 1.5rem;
             font-weight: 600;
         }
        h2 {
             color: #495057; text-align: center; margin-bottom: 15px; font-size: 1.15rem;
             font-weight: 500; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;
         }
        *:focus-visible {
             outline: 2px solid var(--link-color); outline-offset: 2px; box-shadow: 0 0 0 3px var(--focus-ring-color); border-radius: 4px;
         }
        *:focus:not(:focus-visible) { outline: none; box-shadow: none; }

        /* Controls Layout */
        .controls { display: flex; flex-direction: column; gap: 12px; margin-bottom: 15px; }
        .controls .control-row { display: flex; align-items: center; flex-wrap: wrap; gap: 8px 12px; }
        .controls label { margin-right: 4px; font-weight: 500; color: var(--text-muted); white-space: nowrap; font-size: 0.9rem;}
        .controls select, .controls button, .controls input[type="text"], .controls input[type="number"] { padding: 7px 10px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 0.9rem; box-sizing: border-box; background-color: #fff; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        .controls select:hover, .controls input:hover { border-color: #a0a0a0; }
        .controls select { flex-grow: 1; min-width: 100px;}
        /* Input styling adjusted */
        .controls input#azk_vormonat {
             min-width: 80px; text-align: center; flex-basis: 85px; /* Slightly wider for Std:Min */
             flex-grow: 0;
         }
        .controls .azk-group { display: flex; align-items: center; gap: 3px; margin-left: 0; }
        .controls .button-group { display: flex; flex-grow: 1; justify-content: flex-start; gap: 8px; width: 100%;}
        .controls .button-group button { flex-grow: 0; width: auto; padding: 7px 12px;}
        .controls button { cursor: pointer; text-align: center; background-color: var(--secondary-color); color: white; border: none;}
        .controls button:hover { filter: brightness(90%); }
        .controls button.toggle-btn { background-color: var(--m1-color); } /* M1 color also used here */

        /* Style for AZK Vormonat error message */
        .error-message { color: var(--danger-color); font-size: 0.8em; margin-left: 5px; white-space: nowrap; }
        #azk_vormonat:invalid { border-color: var(--danger-color); }

        /* Prozent Input Control */
        .percent-control { display: flex; align-items: center; padding: 8px 12px; background-color: var(--medium-gray); border-radius: 6px; gap: 10px; flex-wrap: nowrap; margin-bottom: 20px; }
        .percent-control label { white-space: nowrap; color: var(--text-muted); font-weight: 500; font-size: 0.9rem;}
        .percent-control input[type="number"] {
             padding: 7px 10px; border: 1px solid var(--border-color); border-radius: 5px;
             font-size: 0.9rem; background-color: #fff; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
             width: 70px; text-align: right; flex-grow: 0;
        }
        .percent-control input[type="number"]:hover { border-color: #a0a0a0; }
        .percent-control input[type=number]::-webkit-outer-spin-button,
        .percent-control input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .percent-control input[type=number] { -moz-appearance: textfield; }
        .percent-control span#prozentValueDisplay { font-weight: 600; color: var(--primary-color); min-width: 10px; text-align: left; font-size: 0.95rem;}

        /* Kalender */
        .calendar-wrapper { overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; border: 1px solid var(--border-color); border-radius: 8px; }
        #calendar { width: 100%; min-width: 300px; border-collapse: separate; border-spacing: 0; table-layout: fixed; }
        #calendar th { text-align: center; padding: 6px 3px; background-color: var(--medium-gray); color: #495057; font-size: 0.8rem; font-weight: 600; border-bottom: 1px solid var(--border-color); }
        #calendar th:first-child { border-top-left-radius: 7px; }
        #calendar th:last-child { border-top-right-radius: 7px; }
        #calendar td {
            border: none; border-top: 1px solid var(--border-color); border-left: 1px solid var(--border-color);
            height: 75px; vertical-align: top; padding: 3px; position: relative;
            font-size: 0.75rem; cursor: pointer; transition: background-color 0.2s ease;
        }
        #calendar tr td:first-child { border-left: none; }
        #calendar td:hover { background-color: #f1f1f1; }
        #calendar td.today .day-number { background-color: #ffecb3; border-radius: 50%; display: inline-block; width: 1.7em; height: 1.7em; line-height: 1.7em; text-align: center; font-weight: bold; }
        #calendar td.weekend { background-color: var(--weekend-bg); }
        #calendar td.holiday { outline: var(--holiday-border); outline-offset: -1px; }
        #calendar td.half-holiday { outline: var(--half-holiday-border); outline-offset: -1px; }
        #calendar td.other-month { background-color: #f8f9fa; color: var(--dark-gray); cursor: default; }
        #calendar td.other-month .day-number { opacity: 0.5; }
        #calendar td.selected { background-color: #e0efff; outline: var(--selected-outline); outline-offset: -1px; z-index: 1; }
        .day-number { font-weight: 500; display: block; margin-bottom: 2px; font-size: 0.8em; color: var(--text-muted); text-align: left; padding-left: 1px;}
        .day-shift { font-size: 0.7em; padding: 2px 3px; border-radius: 3px; color: white; display: block; margin-top: 2px; text-align: center; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-weight: 500; }
        .shift-f { background-color: var(--frueh-color); }
        /* Use M1 color variable */
        .shift-m1 { background-color: var(--m1-color); }
        .shift-s { background-color: var(--primary-color); } .shift-n { background-color: var(--secondary-color); } .shift-urlaub { background-color: var(--warning-color); color: #333; } .shift-frei { background-color: var(--success-color); }
        .day-balance-container { position: absolute; bottom: 2px; right: 3px; text-align: right; line-height: 1.1; }
        .day-balance, .day-running-balance { display: block; font-size: 0.7em; font-weight: 600; padding: 0px 2px; border-radius: 2px; }
        .day-balance { margin-bottom: 0px; }
        .balance-positive { color: var(--positive-color); } .balance-negative { color: var(--danger-color); }

        /* Legende */
        #legend { font-size: 0.8rem; padding: 10px 15px; background-color: var(--medium-gray); border-radius: 6px; margin-bottom: 20px; color: var(--text-muted); }
        #legend ul { list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 6px 15px; align-items: center; } /* Added align-items */
        #legend li { display: flex; align-items: center; }
        #legend li span { display: inline-block; width: 12px; height: 12px; margin-right: 5px; border-radius: 3px; border: 1px solid #ccc; }
        #legend li span.border-example { border: var(--holiday-border); background-color: transparent; }
        #legend li span.half-border-example { border: var(--half-holiday-border); background-color: transparent; }
        #legend li span.positive-text, #legend li span.negative-text { font-weight: bold; border: none; width: auto; height: auto; background-color: transparent !important; }
        #legend li span.positive-text { color: var(--positive-color); }
        #legend li span.negative-text { color: var(--danger-color); }

        /* Aktionen für Tag */
        #day-actions {
            margin-top: 15px; padding: 15px; background-color: var(--medium-gray);
            border-radius: 8px; display: none; border: 1px solid var(--border-color);
        }
        #day-actions label { display: block; margin-bottom: 12px; font-weight: 600; text-align: center; color: var(--text-color); font-size: 0.95rem;}
        .action-buttons { display: grid; justify-items: center; gap: 8px; }
        .action-buttons .button-row:first-of-type { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; max-width: 380px; }
        .action-buttons .button-row:nth-of-type(2) { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; width: 100%; max-width: 200px; }
        #day-actions button {
             padding: 10px 6px; cursor: pointer; border: none; border-radius: 5px;
             font-size: 0.85rem; color: white; font-weight: 500; width: 100%;
             text-align: center; transition: filter 0.2s ease, box-shadow 0.2s ease;
             line-height: 1.3;
        }
        #day-actions button:hover { filter: brightness(90%); }
        button.btn-frueh { background-color: var(--frueh-color); }
        /* Use M1 color variable */
        button.btn-m1 { background-color: var(--m1-color); }
        button.btn-spaet { background-color: var(--primary-color); } button.btn-nacht { background-color: var(--secondary-color); } button.btn-frei { background-color: var(--success-color); } button.btn-urlaub { background-color: var(--warning-color); color: #333; }
        button.clear {
            background-color: #343a40; color: white; margin-top: 8px;
            grid-column: 1 / -1; justify-self: center; width: 60%; max-width: 200px;
        }
        #day-actions button.active { box-shadow: inset 0 0 0 3px rgba(255, 255, 255, 0.7); filter: brightness(100%); }

        /* Ergebnisse & Accordion */
        #results { margin-top: 20px; padding: 0; background-color: #fff; border: 1px solid var(--border-color); border-radius: 8px; display: none; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .results-summary { padding: 15px; }
        #results h2 { text-align: left; font-size: 1.1rem; margin-top: 0; margin-bottom: 10px; border-bottom: none; font-weight: 600; }
        #results p { margin: 4px 0; font-size: 0.95rem; }
        #results span { font-weight: 600; color: #343a40; }
        #results .veraenderung, #results .endstand { font-size: 1.1rem; font-weight: 700;}
        #results .veraenderung span, #results .endstand span { font-weight: 700; }
        #results .veraenderung.positive span, #results .endstand.positive span { color: var(--positive-color); }
        #results .veraenderung.negative span, #results .endstand.negative span { color: var(--danger-color); }
        .accordion-toggle { display: block; padding: 10px 15px; background-color: var(--medium-gray); cursor: pointer; text-align: left; font-size: 0.9rem; font-weight: 500; border-top: 1px solid var(--border-color); color: var(--link-color); position: relative; }
        .accordion-toggle:hover { background-color: #dde2e6; }
        .accordion-toggle::after { content: '▼'; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 0.8em; transition: transform 0.2s ease; }
        .accordion-toggle.open::after { transform: translateY(-50%) rotate(180deg); }
        .accordion-content { padding: 12px 15px; border-top: 1px solid var(--border-color); background-color: #fdfdff; display: none; }
        .accordion-content p { font-size: 0.85rem; margin: 5px 0 3px 0;}
        .accordion-content .detail-label { font-weight: 600; color: #495057; display: block; margin-top: 8px;}
        .accordion-content .detail-item { margin-left: 15px; font-size: 0.8rem; }
        .accordion-content hr { border:0; border-top: 1px solid #eee; margin: 10px 0; }

        /* Media Queries for Desktop */
        @media (min-width: 768px) {
             body { font-size: 16px; padding: 25px; }
             .container { padding: 30px 35px; border-radius: 10px; }
             h1 { font-size: 2rem; margin-bottom: 25px;}
             h2 { font-size: 1.4rem; margin-bottom: 25px; padding-bottom: 10px;}
             .controls { flex-direction: row; align-items: center; gap: 20px; margin-bottom: 20px; }
             .controls .control-row:first-of-type { flex-grow: 1; flex-wrap: nowrap; justify-content: flex-start; }
             .azk-group { margin-left: auto; gap: 5px;}
             .controls .button-group { justify-content: flex-end; margin-top: 0; width: auto;}
             .controls input#azk_vormonat { flex-basis: 90px; } /* Adjusted width */
             .controls select, .controls button, .controls input[type="text"], .controls input[type="number"] { font-size: 1rem; padding: 9px 14px;}
             .controls label { font-size: 1rem; }
             .percent-control { gap: 15px; padding: 10px 15px; margin-bottom: 25px; }
             .percent-control label { font-size: 1rem;}
             .percent-control input[type="number"] { font-size: 1rem; padding: 9px 14px; width: 80px;}
             .percent-control span#prozentValueDisplay { font-size: 1rem;}
             #calendar { min-width: 600px; }
             #calendar th { padding: 10px 5px; font-size: 0.9rem;}
             #calendar td { height: 90px; font-size: 0.9rem; padding: 6px;}
             .day-number { font-size: 0.9em; margin-bottom: 3px;}
             .day-shift { font-size: 0.8em; padding: 2px 5px; margin-top: 4px;}
             .day-balance-container { bottom: 6px; right: 6px; }
             .day-balance, .day-running-balance { font-size: 0.8em; }
             #legend { font-size: 0.9rem; padding: 12px 18px; margin-bottom: 30px; }
             #legend li span { width: 14px; height: 14px; margin-right: 6px;}
             #day-actions { margin-top: 25px; padding: 18px;}
             #day-actions label { font-size: 1rem;}
             .action-buttons .button-row:first-of-type { max-width: 420px; }
             .action-buttons .button-row:nth-of-type(2) { max-width: 220px; }
             #day-actions button { font-size: 0.95rem; padding: 9px 5px;}
             button.clear { width: 50%; max-width: 180px; }
             #results { margin-top: 25px; }
             .results-summary { padding: 15px 20px; }
             #results h2 { font-size: 1.2rem; margin-bottom: 12px;}
             #results p { font-size: 1.05rem; margin: 5px 0;}
             #results .veraenderung, #results .endstand { font-size: 1.25rem; }
             .accordion-toggle { padding: 10px 20px; font-size: 0.95rem;}
             .accordion-toggle::after { right: 20px;}
             .accordion-content { padding: 15px 20px;}
             .accordion-content p { font-size: 0.9rem; margin: 5px 0;}
             .accordion-content .detail-item { margin-left: 20px; font-size: 0.85rem; }
             .accordion-content hr { margin: 12px 0;}
         }

         /* Specific overrides for very small screens */
         @media (max-width: 420px) {
               body { padding: 5px; }
               .container { padding: 10px; }
               h1 { font-size: 1.3rem; }
               h2 { font-size: 1.05rem; }
               .controls .control-row { flex-direction: column; align-items: stretch; }
               .controls .azk-group { margin-left: 0; margin-top: 8px; justify-content: center; }
               .controls input#azk_vormonat { flex-basis: 80px; } /* Adjusted width */
               .controls .button-group { margin-top: 10px; justify-content: center; }
               .percent-control { flex-direction: column; align-items: stretch; gap: 8px; }
               .percent-control input[type="number"] { width: 65px; align-self: center; }
               .error-message { font-size: 0.75em; margin-left: 3px;}
               .action-buttons .button-row:first-of-type { grid-template-columns: repeat(2, 1fr); max-width: 250px; }
               .action-buttons .button-row:nth-of-type(2) { grid-template-columns: repeat(2, 1fr); max-width: 200px; }
               #day-actions button { max-width: none; }
               button.clear { width: 80%; grid-column: 1 / -1; }
               #legend ul { gap: 5px 10px; }
               #calendar td { height: 70px; }
         }

    </style>
</head>
<body>
    <div class="container">
        <h1>Stundenkonto Monatsübersicht</h1>

        <!-- Disclaimer removed -->

        <div class="controls">
            <div class="control-row">
                <label for="month">Monat:</label> <select id="month"></select>
                <label for="year">Jahr:</label> <select id="year"></select>
                <div class="azk-group">
                    <label for="azk_vormonat">AZK Vormonat:</label>
                    <!-- Input type="text" mit inputmode="numeric" und JS-Formatierung -->
                    <input type="text" id="azk_vormonat" placeholder="Std:Min" inputmode="numeric" pattern="^-?\d{1,}:[0-5]\d$" maxlength="6">
                    <span id="azk_error" class="error-message"></span>
                </div>
            </div>
             <div class="control-row">
                 <div class="button-group">
                     <button id="toggleBalanceBtn" class="toggle-btn" onclick="toggleDailyBalanceDisplay()">Saldo Anzeigen</button>
                 </div>
             </div>
        </div> <!-- Ende von .controls -->

        <!-- PDF Export Button -->
        <div style="text-align: center; margin-bottom: 20px;">
            <button id="exportPdfBtn" onclick="exportToPDF()" style="padding: 9px 18px; font-size: 0.95rem; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer;">
                Monatsübersicht als PDF
            </button>
        </div>

        <div class="percent-control">
             <label for="prozent">Arbeitszeit:</label>
             <input type="number" id="prozent" min="0" max="100" step="0.5" value="100" inputmode="decimal">
             <span id="prozentValueDisplay">%</span>
        </div>

         <div class="calendar-wrapper">
             <table id="calendar">
                 <thead>
                     <tr><th>Mo</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th><th>Sa</th><th>So</th></tr>
                 </thead>
                 <tbody id="calendar-body"></tbody>
             </table>
         </div>

        <!-- Aktions-Buttons angepasst -->
        <div id="day-actions">
             <label>Aktionen für <span id="selected-day-display">--.--.----</span>:</label>
             <div class="action-buttons">
                 <div class="button-row"> <!-- Row 1: Früh, M1, Spät, Nacht -->
                     <button data-shift="f" class="btn-frueh" onclick="assignShift('f')">Früh</button>
                     <button data-shift="m1" class="btn-m1" onclick="assignShift('m1')">M1</button> <!-- M1 Button -->
                     <button data-shift="s" class="btn-spaet" onclick="assignShift('s')">Spät</button>
                     <button data-shift="n" class="btn-nacht" onclick="assignShift('n')">Nacht</button>
                 </div>
                 <div class="button-row"> <!-- Row 2: Frei, Urlaub -->
                     <button data-shift="frei" class="btn-frei" onclick="assignShift('frei')">Frei</button>
                     <button data-shift="urlaub" class="btn-urlaub" onclick="assignShift('urlaub')">Urlaub</button>
                     <!-- Holiday Toggle Button removed -->
                 </div>
                 <button class="clear" onclick="assignShift(null)">Eintrag löschen</button>
             </div>
         </div>

         <!-- Legende angepasst -->
         <div id="legend">
            <strong>Legende:</strong>
            <ul style="align-items: center;">
                <li><span style="background-color: var(--frueh-color);"></span> Früh</li>
                <li><span style="background-color: var(--m1-color);"></span> M1</li> <!-- M1 Legend Item -->
                <li><span style="background-color: var(--primary-color);"></span> Spät</li>
                <li><span style="background-color: var(--secondary-color);"></span> Nacht</li>
                <li><span style="background-color: var(--success-color);"></span> Frei</li>
                <li><span style="background-color: var(--warning-color);"></span> Urlaub</li>
                <li><span class="border-example"></span> Feiertag</li>
                <li><span class="half-border-example"></span> Halber FT</li>
                <li style="margin-left: auto;">
                    <small>Δ Tgl. Saldo / Σ Lfd. Saldo</small>
                    <span class="positive-text" style="margin-left: 5px;">+</span>/<span class="negative-text">-</span>
                </li>
            </ul>
         </div>

         <!-- Ergebnisbereich -->
         <div id="results">
             <div class="results-summary">
                 <h2>Monatsbilanz</h2>
                 <p>Monatliches Soll: <span id="res_monatssoll">--:--</span> (<span id="res_werktage_anzahl">--</span> Tage)</p>
                 <p>Monatliches Haben: <span id="res_gutschrift_gesamt">--:--</span></p>
                 <p class="veraenderung">Veränderung Monat: <span id="res_veraenderung">--:--</span></p>
                 <hr style="border:0; border-top: 1px dashed #ccc; margin: 8px 0;">
                 <p class="endstand">Neuer Kontostand: <span id="res_endstand">--:--</span></p>
             </div>
             <div class="accordion-toggle" onclick="toggleAccordion(this)">Details anzeigen</div>
             <!-- Detailansicht überarbeitet -->
             <div class="accordion-content">
                 <p><strong class="detail-label">Basisdaten (<span id="res_detail_month_year">--</span>)</strong></p>
                 <p class="detail-item">AZK Vormonat (Eingabe): <span id="res_azk_vormonat_used">--:--</span></p>
                 <p class="detail-item">Arbeitspensum: <span id="res_prozent">--</span>%</p>
                 <p class="detail-item">Persönliches Tagessoll: <span id="res_tagessoll">--:--</span></p>
                 <!-- Urlaub Gutschrift Info entfernt -->
                 <p class="detail-item">Urlaubstage (an Soll-Tagen): <span id="res_urlaub_tage">--</span></p>
                 <hr>
                 <p><strong class="detail-label">Stundengutschrift Werktage (Mo-Fr, kein FT): <span id="res_detail_wd_total">--:--</span></strong></p>
                 <p class="detail-item">Frühdienste: <span id="res_detail_wd_f">--:--</span></p>
                 <p class="detail-item">M1-Dienste: <span id="res_detail_wd_m1">--:--</span></p> <!-- M1 Detail -->
                 <p class="detail-item">Spätdienste: <span id="res_detail_wd_s">--:--</span></p>
                 <p class="detail-item">Nachtdienste: <span id="res_detail_wd_n">--:--</span></p>
                 <hr>
                 <p><strong class="detail-label">Stundengutschrift Feiertage & Wochenende: <span id="res_detail_weft_total">--:--</span></strong></p>
                 <p class="detail-item">Frühdienste: <span id="res_detail_weft_f">--:--</span></p>
                 <p class="detail-item">M1-Dienste: <span id="res_detail_weft_m1">--:--</span></p> <!-- M1 Detail -->
                 <p class="detail-item">Spätdienste: <span id="res_detail_weft_s">--:--</span></p>
                 <p class="detail-item">Nachtdienste: <span id="res_detail_weft_n">--:--</span></p>
             </div>
         </div>

    </div>

    <script>
        // --- Konstanten ---
        const MINUTEN_FS_DIENST = 450; // 7h 30m (Früh, Spät, M1)
        const MINUTEN_NACHT_DIENST = 573; // 9h 33m
        const MINUTEN_BASIS_VOLLZEIT_WOCHE = 2310; // 38.5 * 60
        const TAGE_PRO_WOCHE = 5.0;
        const monthNames = ["Januar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
        const VALID_SHIFT_TYPES_FOR_JUMP = ['f', 'm1', 's', 'n', 'frei', 'urlaub']; // Added 'm1'
        const LS_KEYS = { // Keys for localStorage
            DATA: 'stundenkonto_dailyData',
            MONTH: 'stundenkonto_currentMonth',
            YEAR: 'stundenkonto_currentYear',
            AZK: 'stundenkonto_azkVormonat',
            PERCENT: 'stundenkonto_prozent'
        };

        // --- Helper-Funktionen ---
        function formatDate(date) { const d = new Date(date); const month = ('0' + (d.getMonth() + 1)).slice(-2); const day = ('0' + d.getDate()).slice(-2); const year = d.getFullYear(); return `${year}-${month}-${day}`; }
        function minutesToHHMM(totalMinutes) { if (isNaN(totalMinutes) || totalMinutes === null) { return "--:--"; } const sign = totalMinutes < 0 ? "-" : ""; const absMinutes = Math.abs(totalMinutes); let hours = Math.floor(absMinutes / 60); let minutes = Math.round(absMinutes % 60); if (minutes === 60) { hours += 1; minutes = 0; } const formattedMinutes = String(minutes).padStart(2, '0'); return sign + hours + ":" + formattedMinutes; }

        // --- Validation Function (remains the same, validates final HH:MM format) ---
        function validateAzkFormat(timeString) {
            if (timeString === null || timeString === undefined) return false;
            timeString = String(timeString).trim();
            if (timeString === "") return true; // Empty is allowed
            const regex = /^(-?)(\d{1,})(?::)([0-5]\d)$/; // Strict check: hours:minutes(00-59)
            const match = timeString.match(regex);
            if (!match) {
                return false;
            }
            // Optional: Check if hours make sense (not strictly necessary for balance)
            // const hoursPart = match[2];
            // if (isNaN(parseInt(hoursPart, 10))) { return false; }
            return true;
        }

        function parseHHMMToMinutes(timeString) { if (!validateAzkFormat(timeString)) { return 0; } timeString = String(timeString).trim(); if (timeString === "") return 0; const sign = timeString.startsWith('-') ? -1 : 1; const timePart = sign === -1 ? timeString.substring(1) : timeString; const parts = timePart.split(':'); if (parts.length !== 2) { return 0; } const hours = parseInt(parts[0], 10); const minutes = parseInt(parts[1], 10); if (isNaN(hours) || isNaN(minutes) || hours < 0 || minutes < 0 || minutes >= 60) { return 0; } return sign * ((hours * 60) + minutes); }

        // --- Feiertagsberechnung ---
        function calculateEasterSunday(year) { const a = year % 19; const b = Math.floor(year / 100); const c = year % 100; const d = Math.floor(b / 4); const e = b % 4; const f = Math.floor((b + 8) / 25); const g = Math.floor((b - f + 1) / 3); const h = (19 * a + b - d - g + 15) % 30; const i = Math.floor(c / 4); const k = c % 4; const l = (32 + 2 * e + 2 * i - h - k) % 7; const m = Math.floor((a + 11 * h + 22 * l) / 451); const month = Math.floor((h + l - 7 * m + 114) / 31); const day = ((h + l - 7 * m + 114) % 31) + 1; return new Date(year, month - 1, day); }
        function addDays(date, days) { const result = new Date(date); result.setDate(result.getDate() + days); return result; }
        const holidaysBY = new Set();
        function populateHolidays(years) { holidaysBY.clear(); years.forEach(year => { holidaysBY.add(`${year}-01-01`); holidaysBY.add(`${year}-01-06`); holidaysBY.add(`${year}-05-01`); holidaysBY.add(`${year}-08-15`); holidaysBY.add(`${year}-10-03`); holidaysBY.add(`${year}-11-01`); holidaysBY.add(`${year}-12-25`); holidaysBY.add(`${year}-12-26`); const easterSunday = calculateEasterSunday(year); holidaysBY.add(formatDate(addDays(easterSunday, -2))); holidaysBY.add(formatDate(addDays(easterSunday, 1))); holidaysBY.add(formatDate(addDays(easterSunday, 39))); holidaysBY.add(formatDate(addDays(easterSunday, 50))); holidaysBY.add(formatDate(addDays(easterSunday, 60))); }); }
        populateHolidays([2024, 2025, 2026]); // Initial population
        function isHoliday(dateStr) { return holidaysBY.has(dateStr); }
        function isHalfDayHoliday(dateStr) { const year = parseInt(dateStr.substring(0, 4), 10); const monthDay = dateStr.substring(5); if (monthDay === '12-24') { return true; } const easterSunday = calculateEasterSunday(year); const shroveTuesday = addDays(easterSunday, -47); // Faschingsdienstag
              if (dateStr === formatDate(shroveTuesday)) { return true; } return false; }

        // --- localStorage Funktionen ---
        function saveDataToLocalStorage() { try { localStorage.setItem(LS_KEYS.DATA, JSON.stringify(dailyData)); localStorage.setItem(LS_KEYS.MONTH, currentMonth.toString()); localStorage.setItem(LS_KEYS.YEAR, currentYear.toString()); localStorage.setItem(LS_KEYS.AZK, azkVormonatInput.value); localStorage.setItem(LS_KEYS.PERCENT, prozentInput.value); } catch (e) { console.error("Fehler beim Speichern im localStorage:", e); } }
        function loadDataFromLocalStorage() { try { const storedData = localStorage.getItem(LS_KEYS.DATA); const storedMonth = localStorage.getItem(LS_KEYS.MONTH); const storedYear = localStorage.getItem(LS_KEYS.YEAR); const storedAzk = localStorage.getItem(LS_KEYS.AZK); const storedPercent = localStorage.getItem(LS_KEYS.PERCENT); if (storedData) { dailyData = JSON.parse(storedData); } currentMonth = storedMonth !== null ? parseInt(storedMonth, 10) : new Date().getMonth(); currentYear = storedYear !== null ? parseInt(storedYear, 10) : new Date().getFullYear(); if (isNaN(currentMonth) || currentMonth < 0 || currentMonth > 11) currentMonth = new Date().getMonth(); if (isNaN(currentYear) ) currentYear = new Date().getFullYear(); azkVormonatInput.value = storedAzk || ""; prozentInput.value = storedPercent || "100.0"; } catch (e) { console.error("Fehler beim Laden aus dem localStorage:", e); dailyData = {}; currentMonth = new Date().getMonth(); currentYear = new Date().getFullYear(); azkVormonatInput.value = ""; prozentInput.value = "100.0"; } }

        // --- Globale Variablen ---
        let currentYear, currentMonth; // Will be set by loadDataFromLocalStorage
        let dailyData = {}; // Structure: { "YYYY-MM-DD": { shift: "type" } }
        let selectedDate = null; let showDailyBalance = false;

        // --- DOM Elemente ---
        const monthSelect = document.getElementById('month'); const yearSelect = document.getElementById('year');
        const calendarBody = document.getElementById('calendar-body');
        const prozentInput = document.getElementById('prozent');
        const prozentValueDisplay = document.getElementById('prozentValueDisplay');
        const dayActionsDiv = document.getElementById('day-actions');
        const selectedDaySpan = document.getElementById('selected-day-display'); const resultsDiv = document.getElementById('results');
        const accordionContent = document.querySelector('.accordion-content'); const toggleBalanceBtn = document.getElementById('toggleBalanceBtn');
        const azkVormonatInput = document.getElementById('azk_vormonat');
        const azkErrorSpan = document.getElementById('azk_error');

        // --- NEUE Funktion zur automatischen Formatierung des AZK Inputs ---
        function formatAzkInput(event) {
            const input = event.target;
            let value = input.value;
            let originalLength = value.length;
            let cursorPosition = input.selectionStart;

            // Nur Ziffern und optional ein führendes Minuszeichen zulassen
            let isNegative = value.startsWith('-');
            let digits = value.replace(/[^\d]/g, ''); // Alle Nicht-Ziffern entfernen

            // Maximale Ziffernlänge begrenzen (z.B. 4 für HHMM)
            const maxLength = 4; // Max 2 für Std, 2 für Min
            if (digits.length > maxLength) {
                digits = digits.slice(0, maxLength);
            }

            let formattedValue = "";
            if (isNegative) {
                formattedValue = "-";
            }

            if (digits.length === 0) {
                // Leer oder nur "-"
                formattedValue = isNegative ? "-" : "";
            } else if (digits.length <= 2) {
                // Nur Stunden oder Teile davon
                formattedValue += digits;
                 // Wenn 2 Ziffern und ":" fehlt, ":"" hinzufügen (außer bei negativem Vorzeichen direkt davor)
                if(digits.length == 2 && !value.includes(':') && !(isNegative && formattedValue.length == 3)) {
                    formattedValue += ":";
                }
            } else {
                // Stunden und Minuten
                let hours = digits.slice(0, digits.length - 2);
                let minutes = digits.slice(digits.length - 2);
                // Stelle sicher, dass Minuten nicht > 59 sind (einfache Begrenzung)
                if (parseInt(minutes, 10) > 59) {
                    minutes = "59"; // Oder alternativ die letzte Ziffer löschen? "59" ist einfacher.
                }
                formattedValue += hours + ":" + minutes;
            }

            // Nur aktualisieren, wenn sich der formatierte Wert geändert hat
            if (input.value !== formattedValue) {
               input.value = formattedValue;

               // Cursorposition versuchen wiederherzustellen/anzupassen
               let lengthDiff = formattedValue.length - originalLength;
               let newCursorPosition = cursorPosition + lengthDiff;

               // Korrektur, wenn direkt vor dem ':' getippt wurde oder ':' hinzugefügt wurde
               if (lengthDiff === 1 && originalLength >= (isNegative ? 3 : 2) && formattedValue.charAt(newCursorPosition -1) === ':') {
                   // If colon was just added, keep cursor after it
               } else if (lengthDiff === 1 && originalLength >= (isNegative ? 1 : 0) && digits.length === 2) {
                   // If colon was added after 2 digits, place cursor at end
                    newCursorPosition = formattedValue.length;
               } else if (lengthDiff < 0 && value.charAt(cursorPosition) === ':') {
                   // If colon was removed by backspace, move cursor back one more
                   newCursorPosition = cursorPosition -1;
               }

               // Verhindern, dass der Cursor an eine unmögliche Stelle springt
               if (newCursorPosition < 0) newCursorPosition = 0;
               if (newCursorPosition > formattedValue.length) newCursorPosition = formattedValue.length;

                try {
                    // Timeout helps sometimes with mobile cursor positioning issues
                    setTimeout(() => {
                        input.setSelectionRange(newCursorPosition, newCursorPosition);
                    }, 0);
                } catch (e) {
                    console.warn("Cursor position could not be set reliably.");
                }
            }

            // Validierungsanzeige aktualisieren (ruft validateAzkFormat intern auf)
            handleAzkInputValidation(); // Separate Funktion für reine Validierungsanzeige
        }

        // --- Angepasste Funktion nur für die Validierungs-Anzeige ---
        function handleAzkInputValidation() {
            const value = azkVormonatInput.value;
            const isValidFinal = validateAzkFormat(value);

            // Fehlermeldung nur anzeigen, wenn es *final* ungültig ist UND nicht leer/nur minus ist
            azkErrorSpan.textContent = (!isValidFinal && value !== "" && value !== "-") ? 'Format: Std:Min' : '';
            // Set custom validity for browser validation, allowing empty string
            azkVormonatInput.setCustomValidity((isValidFinal || value === "") ? '' : 'Ungültiges Format. Erwartet: HH:MM oder -HH:MM');
            // Update aria-invalid based on final validity (ignoring empty state for ARIA)
            azkVormonatInput.setAttribute('aria-invalid', !(isValidFinal || value === ""));
        }


        // --- Initialisierung ---
         function init() {
              loadDataFromLocalStorage(); // Load saved state first
              populateYearSelector();     // Populate UI, selects will match loaded state
              populateMonthSelector();
              handleProzentInput();       // Update % display initially
              handleAzkInputValidation(); // Check initial AZK value validity display

              // Event Listeners
              monthSelect.addEventListener('change', () => { currentMonth = parseInt(monthSelect.value); recalculateIfValid(); });
              yearSelect.addEventListener('change', () => {
                    currentYear = parseInt(yearSelect.value);
                    if (currentYear < 2024 || currentYear > 2026) { console.warn(`Holiday data only available for 2024-2026. Year ${currentYear} selected.`); }
                    else if (!holidaysBY.has(`${currentYear}-01-01`)) { populateHolidays([currentYear]); } // Ensure holidays are loaded for the selected year if within range
                    recalculateIfValid();
              });

              // AZK Input Listener
              azkVormonatInput.addEventListener('input', formatAzkInput); // Formatieren während der Eingabe
              azkVormonatInput.addEventListener('change', recalculateIfValid); // Endgültige Prüfung bei Verlassen

              prozentInput.addEventListener('input', handleProzentInput); // Update display on input
              prozentInput.addEventListener('change', () => { finalizeProzentInput(); recalculateIfValid(); }); // Finalize and recalc on change

              recalculateIfValid(); // Initial calculation & save

              document.addEventListener('click', (event) => {
                  const calendar = document.getElementById('calendar');
                  const actions = document.getElementById('day-actions');
                  // Improved condition to avoid deselect on irrelevant clicks
                   const targetElement = event.target;
                   const isClickInsideCalendar = calendar.contains(targetElement) || targetElement.closest('td[data-date]');
                   const isClickInsideActions = actions.contains(targetElement);
                   const isControlElement = targetElement.closest('.controls') || targetElement.closest('.percent-control') || targetElement.id === 'exportPdfBtn';

                  if (!isClickInsideCalendar && !isClickInsideActions && !isControlElement) {
                     deselectDay();
                  }
              });
         }

         function handleProzentInput() {
            let value = parseFloat(prozentInput.value);
            if (isNaN(value)) {
                prozentValueDisplay.textContent = "%"; // Indicate waiting for valid input
                return;
            }
            value = Math.max(0, Math.min(100, value));
            prozentValueDisplay.textContent = value.toFixed(1) + "%"; // Update display immediately
         }
         // Function called on change event to finalize/normalize the value
         function finalizeProzentInput() {
             let value = parseFloat(prozentInput.value);
             if (isNaN(value)) { value = 100.0; } // Default if invalid on finalize
             value = Math.max(0, Math.min(100, value));
             prozentInput.value = value.toFixed(1); // Set normalized value back to input
             prozentValueDisplay.textContent = value.toFixed(1) + "%"; // Ensure display matches final value
         }

         function recalculateIfValid() {
            handleAzkInputValidation(); // Update AZK validation display
            finalizeProzentInput(); // Finalize and validate Prozent value
            const isAzkValid = validateAzkFormat(azkVormonatInput.value);
            // Prozent is now always valid due to finalizeProzentInput

            if (isAzkValid) {
                loadCalendar(currentYear, currentMonth); // This calls calculateMonthlyBalance
                saveDataToLocalStorage(); // Save the valid state
            } else {
                 resultsDiv.style.display = 'none';
                 // Keep calendar visible but show error message if AZK is invalid
                  calendarBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: var(--danger-color);">Bitte gültiges Format für AZK Vormonat eingeben (Std:Min oder -Std:Min).</td></tr>';
                 deselectDay();
            }
         }
         function populateYearSelector() { const initialYear = new Date().getFullYear(); for (let i = initialYear - 10; i <= initialYear + 5; i++) { const option = document.createElement('option'); option.value = i; option.textContent = i; if (i === currentYear) option.selected = true; yearSelect.appendChild(option); } } // Uses loaded currentYear
         function populateMonthSelector() { monthNames.forEach((name, index) => { const option = document.createElement('option'); option.value = index; option.textContent = name; if (index === currentMonth) option.selected = true; monthSelect.appendChild(option); }); } // Uses loaded currentMonth

        // --- Kalender Logik ---
        function loadCalendar(year, month) {
             calendarBody.innerHTML = '';
             resultsDiv.style.display = 'none';
             accordionContent.style.display = 'none'; document.querySelector('.accordion-toggle').textContent = 'Details anzeigen'; document.querySelector('.accordion-toggle').classList.remove('open');
             deselectDay();

             const startBalanceMinutes = parseHHMMToMinutes(azkVormonatInput.value);
             const prozent = parseFloat(prozentInput.value);
             const tagessoll_minuten_full = Math.round((prozent / 100.0) * (MINUTEN_BASIS_VOLLZEIT_WOCHE / TAGE_PRO_WOCHE));
             const tagessoll_minuten_half = Math.round(tagessoll_minuten_full / 2);
             const firstDayOfMonth = new Date(year, month, 1); const lastDayOfMonth = new Date(year, month + 1, 0); const daysInMonth = lastDayOfMonth.getDate(); const startDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7;
             let date = 1;
             const todayStr = formatDate(new Date());
             let runningBalanceMinutes = startBalanceMinutes;

             for (let i = 0; i < 6; i++) {
                 const row = document.createElement('tr');
                 for (let j = 0; j < 7; j++) {
                     const cell = document.createElement('td');
                     if ((i === 0 && j < startDayOfWeek) || date > daysInMonth) { cell.classList.add('other-month'); }
                     else {
                         const currentDateObj = new Date(year, month, date); const currentDateStr = formatDate(currentDateObj); const dayOfWeek = currentDateObj.getDay(); const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; const isFullHoliday = isHoliday(currentDateStr); const isHalfHoliday = !isFullHoliday && isHalfDayHoliday(currentDateStr);
                         cell.dataset.date = currentDateStr; cell.innerHTML = `<span class="day-number">${date}</span><span class="day-shift"></span><div class="day-balance-container"><span class="day-balance"></span><span class="day-running-balance"></span></div>`;
                         cell.onclick = (event) => { event.stopPropagation(); selectDay(cell, currentDateStr); };
                         if (currentDateStr === todayStr) cell.classList.add('today');
                         if (isWeekend) cell.classList.add('weekend');
                         if (isFullHoliday) cell.classList.add('holiday');
                         if (isHalfHoliday) cell.classList.add('half-holiday');

                         let isWorkdayForSollCalculation = !isWeekend && !isFullHoliday;
                         let dailyTarget_minuten = 0;
                         const isWorkday = dayOfWeek >= 1 && dayOfWeek <= 5; // Mo-Fr

                         if (isWorkdayForSollCalculation) {
                            dailyTarget_minuten = (isHalfHoliday && isWorkday) ? tagessoll_minuten_half : tagessoll_minuten_full;
                         }
                         const dayInfo = dailyData[currentDateStr]; const shiftType = dayInfo?.shift; let dailyCredit_minuten = 0;
                         if (shiftType === 'f' || shiftType === 's' || shiftType === 'm1') dailyCredit_minuten = MINUTEN_FS_DIENST;
                         else if (shiftType === 'n') dailyCredit_minuten = MINUTEN_NACHT_DIENST;
                         else if (shiftType === 'urlaub' && isWorkdayForSollCalculation) { dailyCredit_minuten = tagessoll_minuten_full; } // Urlaubsgutschrift nur an Soll-Tagen
                         const dailyBalance_minuten = dailyCredit_minuten - dailyTarget_minuten;
                         updateDayDisplay(cell, dayInfo, tagessoll_minuten_full, runningBalanceMinutes, isFullHoliday, isHalfHoliday); // Passed tagessoll_minuten_full
                         runningBalanceMinutes += dailyBalance_minuten; date++;
                     }
                     row.appendChild(cell);
                 }
                 calendarBody.appendChild(row);
                 if (date > daysInMonth && i >= Math.ceil((startDayOfWeek + daysInMonth) / 7) - 1) break;
             }
             calculateMonthlyBalance(); // Berechne und zeige Gesamtbilanz
         }

        function deselectDay() { const prevSelected = document.querySelector('#calendar td.selected'); if (prevSelected) prevSelected.classList.remove('selected'); selectedDate = null; dayActionsDiv.style.display = 'none'; selectedDaySpan.textContent = '--.--.----'; }
        function selectDay(cell, dateStr) { if (cell.classList.contains('other-month')) return; deselectDay(); cell.classList.add('selected'); selectedDate = dateStr; selectedDaySpan.textContent = new Date(dateStr).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }); updateActionButtonsUI(dailyData[selectedDate]); dayActionsDiv.style.display = 'block'; }
        function updateActionButtonsUI(dayInfo) { const currentShift = dayInfo?.shift; document.querySelectorAll('#day-actions button[data-shift]').forEach(btn => { btn.classList.toggle('active', btn.dataset.shift === currentShift); }); }

        function assignShift(shiftType) {
             if (!selectedDate) return; const originalDateStr = selectedDate;
             if (shiftType === null) { delete dailyData[originalDateStr]; }
             else { if (!dailyData[originalDateStr]) { dailyData[originalDateStr] = {}; } dailyData[originalDateStr].shift = shiftType; }
             recalculateIfValid(); // Neuberechnung & Speichern
             setTimeout(() => { const originalCell = document.querySelector(`#calendar td[data-date="${originalDateStr}"]`); if (!originalCell || originalCell.closest('tbody') !== calendarBody) return; if (VALID_SHIFT_TYPES_FOR_JUMP.includes(shiftType)) { const currentDate = new Date(originalDateStr); currentDate.setDate(currentDate.getDate() + 1); const nextDateStr = formatDate(currentDate); const nextCell = document.querySelector(`#calendar td[data-date="${nextDateStr}"]`); if (nextCell && !nextCell.classList.contains('other-month')) { selectDay(nextCell, nextDateStr); } else { deselectDay(); } } else { if (originalCell) selectDay(originalCell, originalDateStr); else deselectDay(); } }, 50);
        }

         function updateDayDisplay(cell, dayInfo, tagessoll_minuten_full, runningBalanceStartOfDay_minuten, isFullHoliday, isHalfHoliday) {
             const shiftSpan = cell.querySelector('.day-shift'); const balanceSpan = cell.querySelector('.day-balance'); const runningBalanceSpan = cell.querySelector('.day-running-balance'); if (!shiftSpan || !balanceSpan || !runningBalanceSpan) return;
             const shiftType = dayInfo?.shift; shiftSpan.className = 'day-shift'; shiftSpan.textContent = '';
             if (shiftType) { shiftSpan.classList.add(`shift-${shiftType}`); shiftSpan.textContent = getShiftText(shiftType); } // Use helper
             cell.title = ''; if (isFullHoliday) cell.title = 'Feiertag'; if (isHalfHoliday) cell.title = 'Halber Feiertag'; // Simplified title
             balanceSpan.textContent = ''; balanceSpan.className = 'day-balance'; runningBalanceSpan.textContent = ''; runningBalanceSpan.className = 'day-running-balance';
             if (showDailyBalance) {
                  const dateStr = cell.dataset.date; const dayOfWeek = new Date(dateStr).getDay(); const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                  let dailyTarget_minuten = 0; const isWorkdayForSollCalculation = !isWeekend && !isFullHoliday;
                  const isWorkday = dayOfWeek >= 1 && dayOfWeek <= 5; // Mo-Fr
                   if (isWorkdayForSollCalculation) {
                       dailyTarget_minuten = (isHalfHoliday && isWorkday) ? Math.round(tagessoll_minuten_full / 2) : tagessoll_minuten_full;
                   }
                  let dailyCredit_minuten = 0;
                  if (shiftType === 'f' || shiftType === 's' || shiftType === 'm1') dailyCredit_minuten = MINUTEN_FS_DIENST;
                  else if (shiftType === 'n') dailyCredit_minuten = MINUTEN_NACHT_DIENST;
                  else if (shiftType === 'urlaub' && isWorkdayForSollCalculation) { dailyCredit_minuten = tagessoll_minuten_full; } // Urlaubsgutschrift nur an Soll-Tagen
                  const dailyBalance_minuten = dailyCredit_minuten - dailyTarget_minuten;
                  if (dailyBalance_minuten !== 0 || shiftType) { // Show zero balance if a shift is assigned
                      balanceSpan.textContent = "Δ " + minutesToHHMM(dailyBalance_minuten);
                      balanceSpan.classList.add(dailyBalance_minuten >= 0 ? 'balance-positive' : 'balance-negative');
                  }
                  const runningBalanceEndOfDay_minuten = runningBalanceStartOfDay_minuten + dailyBalance_minuten;
                  runningBalanceSpan.textContent = "Σ " + minutesToHHMM(runningBalanceEndOfDay_minuten);
                  runningBalanceSpan.classList.add(runningBalanceEndOfDay_minuten >= 0 ? 'balance-positive' : 'balance-negative');
             }
         }
         function toggleDailyBalanceDisplay() {
               showDailyBalance = !showDailyBalance; toggleBalanceBtn.textContent = showDailyBalance ? 'Saldo Verbergen' : 'Saldo Anzeigen';
               recalculateIfValid(); const previouslySelectedDate = selectedDate;
                if (previouslySelectedDate) { setTimeout(() => { const cell = document.querySelector(`#calendar td[data-date="${previouslySelectedDate}"]`); if (cell && cell.closest('tbody') === calendarBody) { selectDay(cell, previouslySelectedDate); } else { deselectDay(); } }, 50); }
         }

        function calculateMonthlyBalance() {
             const startBalanceMinutes = parseHHMMToMinutes(azkVormonatInput.value); const prozent = parseFloat(prozentInput.value); if (isNaN(prozent)) return;
             const year = parseInt(yearSelect.value); const month = parseInt(monthSelect.value); const tagessoll_minuten_full = Math.round((prozent / 100.0) * (MINUTEN_BASIS_VOLLZEIT_WOCHE / TAGE_PRO_WOCHE)); const tagessoll_minuten_half = Math.round(tagessoll_minuten_full / 2);
             let monatssoll_minuten = 0; let gutschrift_gesamt_minuten = 0; let urlaub_tage_anzahl = 0; let werktage_im_monat_fuer_soll_count = 0;
             let gutschrift_wd_f = 0, gutschrift_wd_m1 = 0, gutschrift_wd_s = 0, gutschrift_wd_n = 0; let gutschrift_weft_f = 0, gutschrift_weft_m1 = 0, gutschrift_weft_s = 0, gutschrift_weft_n = 0;
             const daysInMonth = new Date(year, month + 1, 0).getDate();
             for (let day = 1; day <= daysInMonth; day++) {
                 const currentDateObj = new Date(year, month, day); const currentDateStr = formatDate(currentDateObj); const dayOfWeek = currentDateObj.getDay(); const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; const isFullHoliday = isHoliday(currentDateStr); const isHalfHoliday = !isFullHoliday && isHalfDayHoliday(currentDateStr); const dayInfo = dailyData[currentDateStr]; const shift = dayInfo?.shift;
                 let dailyTarget_minuten = 0; const isPotentialWorkday = !isWeekend && !isFullHoliday;
                 const isWorkday = dayOfWeek >= 1 && dayOfWeek <= 5; // Mo-Fr

                 if(isPotentialWorkday) {
                     if(isHalfHoliday && isWorkday) {
                        dailyTarget_minuten = tagessoll_minuten_half;
                        werktage_im_monat_fuer_soll_count += 0.5;
                     } else {
                        dailyTarget_minuten = tagessoll_minuten_full;
                        werktage_im_monat_fuer_soll_count += 1.0;
                     }
                 }
                 monatssoll_minuten += dailyTarget_minuten;

                 let dailyCredit_minuten = 0;
                 let isWorkdayCredit = isPotentialWorkday && !(isHalfHoliday && isWorkday);
                 let isWEFTHolidayCredit = isWeekend || isFullHoliday || (isHalfHoliday && isWorkday);

                 if (shift === 'f') { dailyCredit_minuten = MINUTEN_FS_DIENST; if (isWorkdayCredit) gutschrift_wd_f += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_f += dailyCredit_minuten; }
                 else if (shift === 'm1') { dailyCredit_minuten = MINUTEN_FS_DIENST; if (isWorkdayCredit) gutschrift_wd_m1 += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_m1 += dailyCredit_minuten; }
                 else if (shift === 's') { dailyCredit_minuten = MINUTEN_FS_DIENST; if (isWorkdayCredit) gutschrift_wd_s += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_s += dailyCredit_minuten; }
                 else if (shift === 'n') { dailyCredit_minuten = MINUTEN_NACHT_DIENST; if (isWorkdayCredit) gutschrift_wd_n += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_n += dailyCredit_minuten; }
                 else if (shift === 'urlaub') {
                      if (isPotentialWorkday) {
                          dailyCredit_minuten = tagessoll_minuten_full;
                          urlaub_tage_anzahl++;
                      }
                 }
                 gutschrift_gesamt_minuten += dailyCredit_minuten;
             }
             const veraenderung_minuten = gutschrift_gesamt_minuten - monatssoll_minuten; const endstand_minuten = startBalanceMinutes + veraenderung_minuten;
             const total_wd_credit = gutschrift_wd_f + gutschrift_wd_m1 + gutschrift_wd_s + gutschrift_wd_n; const total_weft_credit = gutschrift_weft_f + gutschrift_weft_m1 + gutschrift_weft_s + gutschrift_weft_n;
             // Update Results Summary
             document.getElementById('res_monatssoll').textContent = minutesToHHMM(monatssoll_minuten); document.getElementById('res_werktage_anzahl').textContent = werktage_im_monat_fuer_soll_count.toFixed(1).replace('.0', ''); document.getElementById('res_gutschrift_gesamt').textContent = minutesToHHMM(gutschrift_gesamt_minuten); const veraenderungElement = document.getElementById('res_veraenderung'); veraenderungElement.textContent = minutesToHHMM(veraenderung_minuten); veraenderungElement.parentElement.className = 'veraenderung ' + (veraenderung_minuten >= 0 ? 'positive' : 'negative'); const endstandElement = document.getElementById('res_endstand'); endstandElement.textContent = minutesToHHMM(endstand_minuten); endstandElement.parentElement.className = 'endstand ' + (endstand_minuten >= 0 ? 'positive' : 'negative');
             // Update Accordion Details
             document.getElementById('res_detail_month_year').textContent = `${monthNames[month]} ${year}`; document.getElementById('res_azk_vormonat_used').textContent = minutesToHHMM(startBalanceMinutes); document.getElementById('res_prozent').textContent = prozent.toFixed(1); document.getElementById('res_tagessoll').textContent = minutesToHHMM(tagessoll_minuten_full);
             document.getElementById('res_urlaub_tage').textContent = urlaub_tage_anzahl;

             document.getElementById('res_detail_wd_total').textContent = minutesToHHMM(total_wd_credit); document.getElementById('res_detail_wd_f').textContent = minutesToHHMM(gutschrift_wd_f); document.getElementById('res_detail_wd_m1').textContent = minutesToHHMM(gutschrift_wd_m1); document.getElementById('res_detail_wd_s').textContent = minutesToHHMM(gutschrift_wd_s); document.getElementById('res_detail_wd_n').textContent = minutesToHHMM(gutschrift_wd_n);
             document.getElementById('res_detail_weft_total').textContent = minutesToHHMM(total_weft_credit); document.getElementById('res_detail_weft_f').textContent = minutesToHHMM(gutschrift_weft_f); document.getElementById('res_detail_weft_m1').textContent = minutesToHHMM(gutschrift_weft_m1); document.getElementById('res_detail_weft_s').textContent = minutesToHHMM(gutschrift_weft_s); document.getElementById('res_detail_weft_n').textContent = minutesToHHMM(gutschrift_weft_n);
             resultsDiv.style.display = 'block'; // Show results section
         }

        // --- Accordion Funktion ---
        function toggleAccordion(toggleElement) { const content = accordionContent; const isOpen = content.style.display === "block"; content.style.display = isOpen ? "none" : "block"; toggleElement.textContent = isOpen ? 'Details verbergen' : 'Details anzeigen'; toggleElement.classList.toggle('open', !isOpen); }

        // --- PDF Export Funktion (using jsPDF and jsPDF-AutoTable) ---
        function exportToPDF() {
            // Check jsPDF first
            if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
                alert("jsPDF konnte nicht geladen werden. Bitte Seite neu laden.");
                return;
            }

            const { jsPDF } = jspdf;
            const doc = new jsPDF(); // Create instance *before* checking AutoTable

            // Check if autoTable method exists on the instance (Corrected Check)
            if (typeof doc.autoTable !== 'function') {
                 alert("jsPDF-AutoTable konnte nicht geladen werden. Bitte Seite neu laden.");
                 console.error("Fehler: doc.autoTable ist keine Funktion. Prüfe, ob das AutoTable Plugin korrekt geladen wurde und nach jsPDF eingebunden ist.");
                 console.error("jsPDF Instanz:", doc);
                 console.error("window.jspdf Objekt:", window.jspdf);
                 return;
             }

            // --- Proceed with the rest of the PDF generation ---
            const startBalanceMinutes = parseHHMMToMinutes(azkVormonatInput.value); const prozent = parseFloat(prozentInput.value); if (isNaN(prozent)) { alert("Ungültiger Prozentwert."); return; }
            const year = parseInt(yearSelect.value); const month = parseInt(monthSelect.value); const tagessoll_minuten_full = Math.round((prozent / 100.0) * (MINUTEN_BASIS_VOLLZEIT_WOCHE / TAGE_PRO_WOCHE)); const tagessoll_minuten_half = Math.round(tagessoll_minuten_full / 2);
            let monatssoll_minuten = 0; let gutschrift_gesamt_minuten = 0; let urlaub_tage_anzahl = 0; let werktage_im_monat_fuer_soll_count = 0; let gutschrift_wd_f = 0, gutschrift_wd_m1 = 0, gutschrift_wd_s = 0, gutschrift_wd_n = 0; let gutschrift_weft_f = 0, gutschrift_weft_m1 = 0, gutschrift_weft_s = 0, gutschrift_weft_n = 0; const daysInMonth = new Date(year, month + 1, 0).getDate();
            let dailyDetailsForPDF = []; // Array for AutoTable
            let runningBalancePDF = startBalanceMinutes; // Initialize running balance for PDF table

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDateObj = new Date(year, month, day); const currentDateStr = formatDate(currentDateObj); const dayOfWeek = currentDateObj.getDay(); const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; const isFullHoliday = isHoliday(currentDateStr); const isHalfHoliday = !isFullHoliday && isHalfDayHoliday(currentDateStr); const dayInfo = dailyData[currentDateStr]; const shift = dayInfo?.shift;
                let dailyTarget_minuten = 0; const isPotentialWorkday = !isWeekend && !isFullHoliday;
                const isWorkday = dayOfWeek >= 1 && dayOfWeek <= 5; // Mo-Fr

                if(isPotentialWorkday) { if(isHalfHoliday && isWorkday) { dailyTarget_minuten = tagessoll_minuten_half; werktage_im_monat_fuer_soll_count += 0.5; } else { dailyTarget_minuten = tagessoll_minuten_full; werktage_im_monat_fuer_soll_count += 1.0; } } monatssoll_minuten += dailyTarget_minuten;
                let dailyCredit_minuten = 0; let isWorkdayCredit = isPotentialWorkday && !(isHalfHoliday && isWorkday); let isWEFTHolidayCredit = isWeekend || isFullHoliday || (isHalfHoliday && isWorkday); let shiftText = shift ? getShiftText(shift) : "-";
                if (shift === 'f') { dailyCredit_minuten = MINUTEN_FS_DIENST; if (isWorkdayCredit) gutschrift_wd_f += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_f += dailyCredit_minuten; }
                else if (shift === 'm1') { dailyCredit_minuten = MINUTEN_FS_DIENST; if (isWorkdayCredit) gutschrift_wd_m1 += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_m1 += dailyCredit_minuten; }
                else if (shift === 's') { dailyCredit_minuten = MINUTEN_FS_DIENST; if (isWorkdayCredit) gutschrift_wd_s += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_s += dailyCredit_minuten; }
                else if (shift === 'n') { dailyCredit_minuten = MINUTEN_NACHT_DIENST; if (isWorkdayCredit) gutschrift_wd_n += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_n += dailyCredit_minuten; }
                else if (shift === 'urlaub') { if (isPotentialWorkday) { dailyCredit_minuten = tagessoll_minuten_full; urlaub_tage_anzahl++; } }
                gutschrift_gesamt_minuten += dailyCredit_minuten;
                const dailyBalance_minuten = dailyCredit_minuten - dailyTarget_minuten;
                runningBalancePDF += dailyBalance_minuten; // Update running balance for this day

                 const dayFormatted = ('0' + day).slice(-2); const dayName = ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"][dayOfWeek]; let holidayMarker = ""; if (isFullHoliday) holidayMarker = "(FT)"; else if (isHalfHoliday && isWorkday) holidayMarker = "(HFT)";
                 dailyDetailsForPDF.push([
                    `${dayFormatted}. ${dayName} ${holidayMarker}`,
                    shiftText,
                    minutesToHHMM(dailyBalance_minuten),
                    minutesToHHMM(runningBalancePDF)
                ]);
            }
            const veraenderung_minuten = gutschrift_gesamt_minuten - monatssoll_minuten; const endstand_minuten = startBalanceMinutes + veraenderung_minuten; const total_wd_credit = gutschrift_wd_f + gutschrift_wd_m1 + gutschrift_wd_s + gutschrift_wd_n; const total_weft_credit = gutschrift_weft_f + gutschrift_weft_m1 + gutschrift_weft_s + gutschrift_weft_n;
            const pageHeight = doc.internal.pageSize.height; const pageWidth = doc.internal.pageSize.width; const margin = 15; let yPos = margin;

            function addText(text, x = margin, isBold = false, fontSize = 10, align = 'left') {
                if (yPos + (fontSize * 0.35) > pageHeight - margin) {
                    doc.addPage();
                    yPos = margin;
                    addHeaderFooter();
                }
                doc.setFontSize(fontSize);
                doc.setFont(undefined, isBold ? 'bold' : 'normal');
                doc.text(text, x, yPos, { align: align });
                yPos += (fontSize * 0.45);
            }

            function addLine(x1 = margin, x2 = pageWidth - margin) {
                if (yPos + 2 > pageHeight - margin) { doc.addPage(); yPos = margin; addHeaderFooter(); }
                doc.setDrawColor(200);
                doc.line(x1, yPos, x2, yPos);
                yPos += 3;
            }

            function addHeaderFooter() {
                const pageNum = doc.internal.getNumberOfPages();
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`Seite ${pageNum}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                if (pageNum > 1) {
                   doc.text(`Stundenkonto ${monthNames[month]} ${year} (Fortsetzung)`, margin, 10);
                } else {
                   // Optional: Header on first page if desired
                   doc.text(`Stundenkonto ${monthNames[month]} ${year}`, margin, 10);
                }
                doc.setTextColor(0);
             }

            // --- Start PDF Content ---
            // Add header/footer to the first page
            addHeaderFooter();
            // Reset yPos after header if needed, or adjust initial yPos
            yPos = margin + 5; // Start content slightly below header

            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text(`Stundenkonto Übersicht: ${monthNames[month]} ${year}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 10; // Increased space after title

            addText("Monatsbilanz", margin, true, 12);
            yPos += 2;
            addText(`Monatliches Soll: ${minutesToHHMM(monatssoll_minuten)} (${werktage_im_monat_fuer_soll_count.toFixed(1).replace('.0', '')} Tage)`);
            addText(`Monatliches Haben: ${minutesToHHMM(gutschrift_gesamt_minuten)}`);
            addText(`Veränderung Monat: ${minutesToHHMM(veraenderung_minuten)}`);
            yPos += 1;
            addText(`Neuer Kontostand: ${minutesToHHMM(endstand_minuten)}`, margin, true);
            yPos += 6;
            addLine();

            addText("Details", margin, true, 12);
            yPos += 2;
            addText(`AZK Vormonat: ${minutesToHHMM(startBalanceMinutes)}`);
            addText(`Arbeitspensum: ${prozent.toFixed(1)}%`);
            addText(`Persönliches Tagessoll: ${minutesToHHMM(tagessoll_minuten_full)}`);
            addText(`Urlaubstage (an Soll-Tagen): ${urlaub_tage_anzahl}`);
            yPos += 3;

            addText(`Stundengutschrift Werktage (Mo-Fr, kein FT): ${minutesToHHMM(total_wd_credit)}`, margin, true);
            addText(`  Frühdienste: ${minutesToHHMM(gutschrift_wd_f)}`, margin + 5);
            addText(`  M1-Dienste: ${minutesToHHMM(gutschrift_wd_m1)}`, margin + 5);
            addText(`  Spätdienste: ${minutesToHHMM(gutschrift_wd_s)}`, margin + 5);
            addText(`  Nachtdienste: ${minutesToHHMM(gutschrift_wd_n)}`, margin + 5);
            yPos += 3;

            addText(`Stundengutschrift Feiertage & Wochenende: ${minutesToHHMM(total_weft_credit)}`, margin, true);
            addText(`  Frühdienste: ${minutesToHHMM(gutschrift_weft_f)}`, margin + 5);
            addText(`  M1-Dienste: ${minutesToHHMM(gutschrift_weft_m1)}`, margin + 5);
            addText(`  Spätdienste: ${minutesToHHMM(gutschrift_weft_s)}`, margin + 5);
            addText(`  Nachtdienste: ${minutesToHHMM(gutschrift_weft_n)}`, margin + 5);
            yPos += 8;
            addLine();

            addText("Tagesübersicht", margin, true, 12);
            yPos += 4;

            // --- Generate AutoTable ---
            const tableHeaders = [['Tag', 'Schicht', 'Tagessaldo (Δ)', 'Laufender Saldo (Σ)']];
            doc.autoTable({
                head: tableHeaders,
                body: dailyDetailsForPDF,
                startY: yPos,
                theme: 'grid',
                headStyles: { fillColor: [220, 220, 220], textColor: 40, fontStyle: 'bold' },
                styles: { fontSize: 9, cellPadding: 1.5 },
                columnStyles: {
                    0: { cellWidth: 'auto' },
                    1: { cellWidth: 'auto' },
                    2: { cellWidth: 'auto', halign: 'right' },
                    3: { cellWidth: 'auto', halign: 'right' }
                },
                didDrawPage: (data) => {
                    addHeaderFooter();
                     // Reset yPos for the new page to start below header
                    yPos = margin + 5;
                },
            });

             // Update yPos based on where the table finished
             if (doc.lastAutoTable) {
                yPos = doc.lastAutoTable.finalY + 10;
             }

             // Add footer to the last page explicitly if autoTable didn't trigger didDrawPage for it
             // Check if we are already near the bottom, if so, footer was likely added by didDrawPage
             if (yPos < pageHeight - 20) {
                 addHeaderFooter(); // Needs explicit call only if table finished high on page
             }

            // --- Save PDF ---
            doc.save(`Stundenkonto_${year}_${('0' + (month + 1)).slice(-2)}.pdf`);
        }
        // Helper Function to get shift text
        function getShiftText(shiftType) { switch(shiftType) { case 'f': return 'Früh'; case 'm1': return 'M1'; case 's': return 'Spät'; case 'n': return 'Nacht'; case 'urlaub': return 'Urlaub'; case 'frei': return 'Frei'; default: return '-'; } }

        // --- Start ---
        init();

    </script>

</body>
</html>
