<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stundenkonto Monatsübersicht</title>
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF-AutoTable Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* --- Default Color Variables (used for reset) --- */
        :root {
             /* Base Colors (can be customized) */
             --frueh-color-base: #800020; /* Bordeaux */
             --m1-color-base: #17a2b8; /* Turquoise */
             --spaet-color-base: #0056b3; /* Dark Blue */
             --nacht-color-base: #6c757d; /* Gray */
             --frei-color-base: #28a745; /* Green */
             --urlaub-color-base: #fd7e14; /* Orange */
             --krank-color-base: #6f42c1; /* Violet */
             --holiday-border-color-base: #dc3545; /* Red */
             --half-holiday-border-color-base: #ffc107; /* Yellow/Amber */

             /* Applied Colors (initially set to base, updated by JS) */
             --frueh-color: var(--frueh-color-base);
             --m1-color: var(--m1-color-base);
             --spaet-color: var(--spaet-color-base);
             --nacht-color: var(--nacht-color-base);
             --frei-color: var(--frei-color-base);
             --urlaub-color: var(--urlaub-color-base);
             --krank-color: var(--krank-color-base);
             --holiday-border-color: var(--holiday-border-color-base);
             --half-holiday-border-color: var(--half-holiday-border-color-base);

             /* Other UI Colors (generally not customized by user) */
             --primary-color: #0056b3; /* Kept for buttons etc. Can be same as --spaet-color if desired */
             --secondary-color: #6c757d; /* Kept for buttons etc. */
             --success-color: #28a745; /* Kept for buttons etc. */
             --warning-color: #fd7e14; /* Kept for buttons etc. */
             --danger-color: #dc3545; /* Kept for buttons etc. */
             --positive-color: var(--success-color);
             --light-gray: #f8f9fa;
             --medium-gray: #e9ecef;
             --dark-gray: #adb5bd;
             --border-color: #dee2e6;
             --text-color: #212529;
             --text-muted: #6c757d;
             --link-color: #007bff;
             --focus-ring-color: rgba(0, 123, 255, 0.25);
             --weekend-bg: #f1f3f5;
             --selected-outline: 2px solid var(--link-color);

             /* Derived Styles Using Applied Colors */
             --holiday-border: 2px solid var(--holiday-border-color);
             --half-holiday-border: 2px dashed var(--half-holiday-border-color);
         }

        *, *::before, *::after { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
             font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji';
             line-height: 1.6; margin: 0; padding: 8px;
             background-color: var(--light-gray); color: var(--text-color); font-size: 14px;
             -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
         }
        .container {
             max-width: 950px; margin: 10px auto; padding: 15px;
             background-color: #ffffff; border-radius: 8px;
             box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
         }
        h1 { color: #343a40; text-align: center; margin-top: 0; margin-bottom: 15px; font-size: 1.5rem; font-weight: 600; }
        h2 { color: #495057; text-align: center; margin-bottom: 15px; font-size: 1.15rem; font-weight: 500; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
        *:focus-visible { outline: 2px solid var(--link-color); outline-offset: 2px; box-shadow: 0 0 0 3px var(--focus-ring-color); border-radius: 4px; }
        *:focus:not(:focus-visible) { outline: none; box-shadow: none; }

        /* Controls Layout */
        .controls { display: flex; flex-direction: column; gap: 12px; margin-bottom: 15px; }
        .controls .control-row { display: flex; align-items: center; flex-wrap: wrap; gap: 8px 12px; }
        .controls label { margin-right: 4px; font-weight: 500; color: var(--text-muted); white-space: nowrap; font-size: 0.9rem;}
        .controls select, .controls button, .controls input[type="text"], .controls input[type="number"] { padding: 7px 10px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 0.9rem; box-sizing: border-box; background-color: #fff; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        .controls select:hover, .controls input:hover { border-color: #a0a0a0; }
        .controls select { flex-grow: 1; min-width: 100px;}
        .controls input#azk_vormonat { min-width: 80px; text-align: center; flex-basis: 85px; flex-grow: 0; }
        .controls .azk-group { display: flex; align-items: center; gap: 3px; margin-left: 0; }
        .controls .button-group { display: flex; flex-grow: 1; justify-content: flex-start; gap: 8px; width: 100%;}
        .controls .button-group button { flex-grow: 0; width: auto; padding: 7px 12px;}
        .controls button { cursor: pointer; text-align: center; background-color: var(--secondary-color); color: white; border: none;}
        .controls button:hover { filter: brightness(90%); }
        .controls button.toggle-btn { background-color: var(--m1-color); } /* Note: Might want to make this configurable too? */
        .controls button#clearMonthBtn { background-color: var(--danger-color); }

        /* AZK Error */
        .error-message { color: var(--danger-color); font-size: 0.8em; margin-left: 5px; white-space: nowrap; }
        #azk_vormonat:invalid { border-color: var(--danger-color); }

        /* Percent Control NEW Layout */
        .percent-control { display: flex; align-items: center; padding: 8px 12px; background-color: var(--medium-gray); border-radius: 6px; gap: 10px; flex-wrap: wrap; /* Allow wrapping */ margin-bottom: 20px; }
        .percent-control label { white-space: nowrap; color: var(--text-muted); font-weight: 500; font-size: 0.9rem; flex-shrink: 0; }
        .percent-control input[type="range"] { flex-grow: 1; min-width: 100px; height: 8px; cursor: pointer; accent-color: var(--primary-color); margin: 0 5px; }
        .percent-control input[type="number"] { padding: 7px 10px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 0.9rem; background-color: #fff; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; width: 70px; text-align: right; flex-grow: 0; flex-shrink: 0; }
        .percent-control input[type="number"]:hover { border-color: #a0a0a0; }
        .percent-control input[type=number]::-webkit-outer-spin-button, .percent-control input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .percent-control input[type=number] { -moz-appearance: textfield; }
        .percent-control span#prozentValueDisplay { font-weight: 600; color: var(--primary-color); min-width: 45px; /* Ensure space for 100.0% */ text-align: left; font-size: 0.95rem; flex-shrink: 0; }

        /* Kalender */
        .calendar-wrapper { overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; border: 1px solid var(--border-color); border-radius: 8px; }
        #calendar { width: 100%; min-width: 300px; border-collapse: separate; border-spacing: 0; table-layout: fixed; }
        #calendar th { text-align: center; padding: 6px 3px; background-color: var(--medium-gray); color: #495057; font-size: 0.8rem; font-weight: 600; border-bottom: 1px solid var(--border-color); }
        #calendar th:first-child { border-top-left-radius: 7px; }
        #calendar th:last-child { border-top-right-radius: 7px; }
        #calendar td { border: none; border-top: 1px solid var(--border-color); border-left: 1px solid var(--border-color); height: 75px; vertical-align: top; padding: 3px; position: relative; font-size: 0.75rem; cursor: pointer; transition: background-color 0.2s ease, outline-color 0.2s ease; /* Added outline transition */ }
        #calendar tr td:first-child { border-left: none; }
        #calendar td:hover { background-color: #f1f1f1; }
        #calendar td.today .day-number { background-color: #ffecb3; border-radius: 50%; display: inline-block; width: 1.7em; height: 1.7em; line-height: 1.7em; text-align: center; font-weight: bold; }
        #calendar td.weekend { background-color: var(--weekend-bg); }
        #calendar td.holiday { outline: var(--holiday-border); outline-offset: -1px; }
        #calendar td.half-holiday { outline: var(--half-holiday-border); outline-offset: -1px; }
        #calendar td.other-month { background-color: #f8f9fa; color: var(--dark-gray); cursor: default; }
        #calendar td.other-month .day-number { opacity: 0.5; }
        #calendar td.selected { background-color: #e0efff; outline: var(--selected-outline); outline-offset: -1px; z-index: 1; }
        .day-number { font-weight: 500; display: block; margin-bottom: 2px; font-size: 0.8em; color: var(--text-muted); text-align: left; padding-left: 1px;}
        .day-shift { font-size: 0.7em; padding: 2px 3px; border-radius: 3px; color: white; display: block; margin-top: 2px; text-align: center; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-weight: 500; transition: background-color 0.2s ease; /* Added color transition */ }
        .shift-f { background-color: var(--frueh-color); }
        .shift-m1 { background-color: var(--m1-color); }
        .shift-s { background-color: var(--spaet-color); } /* Use variable */
        .shift-n { background-color: var(--nacht-color); } /* Use variable */
        .shift-urlaub { background-color: var(--urlaub-color); color: #333; } /* Use variable */
        .shift-frei { background-color: var(--frei-color); } /* Use variable */
        .shift-krank { background-color: var(--krank-color); } /* Use variable */
        .day-balance-container { position: absolute; bottom: 2px; right: 3px; text-align: right; line-height: 1.1; }
        .day-balance, .day-running-balance { display: block; font-size: 0.7em; font-weight: 600; padding: 0px 2px; border-radius: 2px; }
        .day-balance { margin-bottom: 0px; }
        .balance-positive { color: var(--positive-color); } .balance-negative { color: var(--danger-color); }

        /* Legende & Color Settings Button */
        .legend-container { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        #legend { font-size: 0.8rem; padding: 10px 15px; background-color: var(--medium-gray); border-radius: 6px; color: var(--text-muted); flex-grow: 1; }
        #legend ul { list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 6px 15px; align-items: center; }
        #legend li { display: flex; align-items: center; }
        #legend li span { display: inline-block; width: 12px; height: 12px; margin-right: 5px; border-radius: 3px; border: 1px solid #ccc; }
        #legend li span.border-example { border: var(--holiday-border); background-color: transparent; }
        #legend li span.half-border-example { border: var(--half-holiday-border); background-color: transparent; }
        #legend li span.positive-text, #legend li span.negative-text { font-weight: bold; border: none; width: auto; height: auto; background-color: transparent !important; }
        #legend li span.positive-text { color: var(--positive-color); }
        #legend li span.negative-text { color: var(--danger-color); }
        #colorSettingsBtn { padding: 6px 10px; font-size: 1.1rem; background: none; border: 1px solid var(--border-color); border-radius: 5px; cursor: pointer; line-height: 1; color: var(--text-muted); background-color: white; }
        #colorSettingsBtn:hover { background-color: var(--medium-gray); color: var(--text-color); }

        /* Aktionen für Tag */
        #day-actions { margin-top: 15px; padding: 15px; background-color: var(--medium-gray); border-radius: 8px; display: none; border: 1px solid var(--border-color); }
        #day-actions label { display: block; margin-bottom: 12px; font-weight: 600; text-align: center; color: var(--text-color); font-size: 0.95rem;}
        .action-buttons { display: grid; justify-items: center; gap: 10px; }
        .action-buttons .button-row { display: grid; gap: 10px; width: 100%; }
        .action-buttons .button-row:first-of-type { grid-template-columns: repeat(4, 1fr); max-width: 380px; }
        .action-buttons .button-row:nth-of-type(2) { grid-template-columns: repeat(3, 1fr); max-width: 300px; }
        #day-actions button { padding: 12px 8px; cursor: pointer; border: none; border-radius: 5px; font-size: 0.9rem; color: white; font-weight: 500; width: 100%; text-align: center; transition: filter 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease; /* Added background transition */ line-height: 1.3; min-height: 44px; display: flex; align-items: center; justify-content: center; }
        #day-actions button:hover { filter: brightness(90%); }
        /* Use CSS variables for button backgrounds */
        button.btn-frueh { background-color: var(--frueh-color); }
        button.btn-m1 { background-color: var(--m1-color); }
        button.btn-spaet { background-color: var(--spaet-color); }
        button.btn-nacht { background-color: var(--nacht-color); }
        button.btn-frei { background-color: var(--frei-color); }
        button.btn-urlaub { background-color: var(--urlaub-color); color: #333; }
        button.btn-krank { background-color: var(--krank-color); }
        button.clear { background-color: #343a40; color: white; margin-top: 8px; grid-column: 1 / -1; justify-self: center; width: 60%; max-width: 200px; }
        #day-actions button.active { box-shadow: inset 0 0 0 3px rgba(255, 255, 255, 0.7); filter: brightness(100%); }

        /* Ergebnisse & Accordion */
        #results { margin-top: 20px; padding: 0; background-color: #fff; border: 1px solid var(--border-color); border-radius: 8px; display: none; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .results-summary { padding: 15px; }
        #results h2 { text-align: left; font-size: 1.1rem; margin-top: 0; margin-bottom: 10px; border-bottom: none; font-weight: 600; }
        #results p { margin: 4px 0; font-size: 0.95rem; }
        #results span { font-weight: 600; color: #343a40; }
        #results .veraenderung, #results .endstand { font-size: 1.1rem; font-weight: 700;}
        #results .veraenderung span, #results .endstand span { font-weight: 700; }
        #results .veraenderung.positive span, #results .endstand.positive span { color: var(--positive-color); }
        #results .veraenderung.negative span, #results .endstand.negative span { color: var(--danger-color); }
        .accordion-toggle { display: block; padding: 10px 15px; background-color: var(--medium-gray); cursor: pointer; text-align: left; font-size: 0.9rem; font-weight: 500; border-top: 1px solid var(--border-color); color: var(--link-color); position: relative; }
        .accordion-toggle:hover { background-color: #dde2e6; }
        .accordion-toggle::after { content: '▼'; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 0.8em; transition: transform 0.2s ease; }
        .accordion-toggle.open::after { transform: translateY(-50%) rotate(180deg); }
        .accordion-content { padding: 12px 15px; border-top: 1px solid var(--border-color); background-color: #fdfdff; display: none; }
        .accordion-content p { font-size: 0.85rem; margin: 5px 0 3px 0;}
        .accordion-content .detail-label { font-weight: 600; color: #495057; display: block; margin-top: 8px;}
        .accordion-content .detail-item { margin-left: 15px; font-size: 0.8rem; }
        .accordion-content hr { border:0; border-top: 1px solid #eee; margin: 10px 0; }

        /* Color Settings Modal */
        #colorSettingsModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); padding-top: 50px; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px 25px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .modal-content h3 { margin-top: 0; color: var(--text-color); text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; line-height: 1; position: absolute; right: 15px; top: 10px; }
        .modal-close:hover, .modal-close:focus { color: black; text-decoration: none; cursor: pointer; }
        .color-picker-group { display: grid; grid-template-columns: auto 1fr auto; gap: 10px 15px; align-items: center; margin-bottom: 12px; }
        .color-picker-group label { font-weight: 500; white-space: nowrap; text-align: right; font-size: 0.9rem; color: var(--text-muted); }
        .color-picker-group input[type="color"] { border: 1px solid var(--border-color); padding: 0; border-radius: 4px; height: 30px; width: 50px; cursor: pointer; background-color: transparent; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
         /* Style the color swatch itself */
        .color-picker-group input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .color-picker-group input[type="color"]::-webkit-color-swatch { border: none; border-radius: 3px; }
        .color-picker-group input[type="color"]::-moz-color-swatch { border: none; border-radius: 3px; }
        .color-value-display { font-family: monospace; font-size: 0.85rem; color: var(--text-muted); min-width: 65px; text-align: left; } /* Shows hex value */
        .modal-actions { margin-top: 25px; text-align: center; display: flex; justify-content: space-around; gap: 15px; flex-wrap: wrap; }
        .modal-actions button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem; font-weight: 500; }
        #saveColorsBtn { background-color: var(--success-color); color: white; }
        #resetColorsBtn { background-color: var(--warning-color); color: #333; }
        #closeModalBtn { background-color: var(--secondary-color); color: white; }
        #saveColorsBtn:hover, #resetColorsBtn:hover, #closeModalBtn:hover { filter: brightness(90%); }

        /* Media Queries adjustments */
        @media (min-width: 768px) {
             body { font-size: 16px; padding: 25px; }
             .container { padding: 30px 35px; }
             h1 { font-size: 2rem; margin-bottom: 25px;}
             h2 { font-size: 1.4rem; margin-bottom: 25px; padding-bottom: 10px;}
             .controls { flex-direction: row; align-items: center; gap: 20px; margin-bottom: 20px; }
             .controls .control-row:first-of-type { flex-grow: 1; flex-wrap: nowrap; justify-content: flex-start; }
             .azk-group { margin-left: auto; gap: 5px;}
             .controls .button-group { justify-content: flex-end; margin-top: 0; width: auto; flex-wrap: nowrap; align-items: center;}
             .controls input#azk_vormonat { flex-basis: 90px; }
             .controls select, .controls button, .controls input[type="text"], .controls input[type="number"] { font-size: 1rem; padding: 9px 14px;}
             .controls label { font-size: 1rem; }
             /* Percent Control Desktop */
             .percent-control { flex-wrap: nowrap; gap: 15px; padding: 10px 15px; margin-bottom: 25px; }
             .percent-control label { font-size: 1rem;}
             .percent-control input[type="range"] { flex-grow: 1; min-width: 150px; }
             .percent-control input[type="number"] { font-size: 1rem; padding: 9px 14px; width: 80px;}
             .percent-control span#prozentValueDisplay { font-size: 1rem;}
             #calendar { min-width: 600px; }
             #calendar th { padding: 10px 5px; font-size: 0.9rem;}
             #calendar td { height: 90px; font-size: 0.9rem; padding: 6px;}
             .day-number { font-size: 0.9em; margin-bottom: 3px;}
             .day-shift { font-size: 0.8em; padding: 2px 5px; margin-top: 4px;}
             .day-balance-container { bottom: 6px; right: 6px; }
             .day-balance, .day-running-balance { font-size: 0.8em; }
             /* Legend Desktop */
             .legend-container { margin-bottom: 30px; }
             #legend { font-size: 0.9rem; padding: 12px 18px; }
             #legend li span { width: 14px; height: 14px; margin-right: 6px;}
             #colorSettingsBtn { font-size: 1.3rem; padding: 8px 12px; }
             #day-actions { margin-top: 25px; padding: 18px;}
             #day-actions label { font-size: 1rem;}
             .action-buttons { gap: 12px; }
             .action-buttons .button-row:first-of-type { max-width: 450px; gap: 12px; }
             .action-buttons .button-row:nth-of-type(2) { grid-template-columns: repeat(3, 1fr); max-width: 340px; gap: 12px; }
             #day-actions button { font-size: 0.95rem; padding: 12px 10px; }
             button.clear { width: 50%; max-width: 180px; }
             #results { margin-top: 25px; }
             .results-summary { padding: 15px 20px; }
             #results h2 { font-size: 1.2rem; margin-bottom: 12px;}
             #results p { font-size: 1.05rem; margin: 5px 0;}
             #results .veraenderung, #results .endstand { font-size: 1.25rem; }
             .accordion-toggle { padding: 10px 20px; font-size: 0.95rem;}
             .accordion-toggle::after { right: 20px;}
             .accordion-content { padding: 15px 20px;}
             .accordion-content p { font-size: 0.9rem; margin: 5px 0;}
             .accordion-content .detail-item { margin-left: 20px; font-size: 0.85rem; }
             .accordion-content hr { margin: 12px 0;}
             /* Modal Desktop */
             .modal-content { padding: 25px 35px; }
             .color-picker-group label { font-size: 1rem; }
             .color-value-display { font-size: 0.9rem; }
         }

         /* Specific overrides for smaller screens */
         @media (max-width: 600px) {
               body { padding: 5px; }
               .container { padding: 10px; }
               h1 { font-size: 1.3rem; }
               h2 { font-size: 1.05rem; }
               .controls .control-row { flex-direction: column; align-items: stretch; }
               .controls .azk-group { margin-left: 0; margin-top: 8px; justify-content: center; }
               .controls input#azk_vormonat { flex-basis: 80px; }
               .controls .button-group { margin-top: 10px; justify-content: center; flex-wrap: wrap;}
               /* Percent Control Mobile */
               .percent-control { flex-direction: column; align-items: stretch; gap: 8px; }
               .percent-control input[type="range"] { width: 100%; min-width: unset; }
               .percent-control input[type="number"] { width: 65px; align-self: center; }
               .percent-control span#prozentValueDisplay { align-self: center; }
               .error-message { font-size: 0.75em; margin-left: 3px;}
               .action-buttons { gap: 12px; }
               .action-buttons .button-row:first-of-type { grid-template-columns: repeat(2, 1fr); max-width: 280px; gap: 12px; }
               .action-buttons .button-row:nth-of-type(2) { grid-template-columns: repeat(3, 1fr); max-width: 320px; gap: 12px; }
               #day-actions button { padding: 15px 10px; font-size: 1rem; min-height: 48px; max-width: none; }
               button.clear { width: 80%; grid-column: 1 / -1; }
               /* Legend Mobile */
               .legend-container { flex-direction: column; align-items: stretch; gap: 10px; }
               #legend ul { gap: 5px 10px; }
               #colorSettingsBtn { align-self: center; width: fit-content; }
               #calendar td { height: 70px; }
               /* Modal Mobile */
               .modal-content { width: 95%; padding: 15px; }
               .color-picker-group { grid-template-columns: auto 1fr auto; gap: 8px 10px; }
               .color-picker-group label { font-size: 0.85rem; }
               .modal-actions button { font-size: 0.85rem; padding: 8px 15px; }
         }
         @media (max-width: 360px) {
            .action-buttons .button-row:first-of-type,
            .action-buttons .button-row:nth-of-type(2) { max-width: 100%; }
         }

    </style>
</head>
<body>
    <div class="container">
        <h1>Stundenkonto Monatsübersicht</h1>

        <!-- Controls -->
        <div class="controls">
            <div class="control-row">
                <label for="month">Monat:</label> <select id="month"></select>
                <label for="year">Jahr:</label> <select id="year"></select>
                <div class="azk-group">
                    <label for="azk_vormonat">AZK Vormonat:</label>
                    <input type="text" id="azk_vormonat" placeholder="Std:Min" inputmode="numeric" pattern="^-?\d{1,}:[0-5]\d$" maxlength="6">
                    <span id="azk_error" class="error-message"></span>
                </div>
            </div>
             <div class="control-row">
                 <div class="button-group">
                     <button id="toggleBalanceBtn" class="toggle-btn" onclick="toggleDailyBalanceDisplay()">Saldo Anzeigen</button>
                     <button id="clearMonthBtn" onclick="clearMonthEntries()">Monat löschen</button>
                 </div>
             </div>
        </div> <!-- Ende .controls -->

        <!-- PDF Export Button -->
        <div style="text-align: center; margin-bottom: 20px;">
            <button id="exportPdfBtn" onclick="exportToPDF()" style="padding: 9px 18px; font-size: 0.95rem; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer;">
                Monatsübersicht als PDF
            </button>
        </div>

        <!-- Percent Control - UPDATED with Slider -->
        <div class="percent-control">
             <label for="prozent">Arbeitszeit:</label>
             <input type="range" id="prozentSlider" min="0" max="100" step="1" value="100">
             <input type="number" id="prozent" min="0" max="100" step="0.1" value="100" inputmode="decimal"> <!-- Step 0.1 for fine input -->
             <span id="prozentValueDisplay">%</span>
        </div>

        <!-- Calendar -->
         <div class="calendar-wrapper">
             <table id="calendar">
                 <thead>
                     <tr><th>Mo</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th><th>Sa</th><th>So</th></tr>
                 </thead>
                 <tbody id="calendar-body"></tbody>
             </table>
         </div>

         <!-- Day Actions -->
         <div id="day-actions">
             <label>Aktionen für <span id="selected-day-display">--.--.----</span>:</label>
             <div class="action-buttons">
                 <div class="button-row"> <!-- Row 1: Früh, M1, Spät, Nacht -->
                     <button data-shift="f" class="btn-frueh" onclick="assignShift('f')">Früh</button>
                     <button data-shift="m1" class="btn-m1" onclick="assignShift('m1')">M1</button>
                     <button data-shift="s" class="btn-spaet" onclick="assignShift('s')">Spät</button>
                     <button data-shift="n" class="btn-nacht" onclick="assignShift('n')">Nacht</button>
                 </div>
                 <div class="button-row"> <!-- Row 2: Frei, Urlaub, Krank -->
                     <button data-shift="frei" class="btn-frei" onclick="assignShift('frei')">Frei</button>
                     <button data-shift="urlaub" class="btn-urlaub" onclick="assignShift('urlaub')">Urlaub</button>
                     <button data-shift="krank" class="btn-krank" onclick="assignShift('krank')">Krank</button>
                 </div>
                 <button class="clear" onclick="assignShift(null)">Eintrag löschen</button>
             </div>
         </div>

         <!-- Legend & Color Settings Button -->
         <div class="legend-container">
            <div id="legend">
                <strong>Legende:</strong>
                <ul style="align-items: center;">
                    <li><span style="background-color: var(--frueh-color);"></span> Früh</li>
                    <li><span style="background-color: var(--m1-color);"></span> M1</li>
                    <li><span style="background-color: var(--spaet-color);"></span> Spät</li>
                    <li><span style="background-color: var(--nacht-color);"></span> Nacht</li>
                    <li><span style="background-color: var(--frei-color);"></span> Frei</li>
                    <li><span style="background-color: var(--urlaub-color);"></span> Urlaub</li>
                    <li><span style="background-color: var(--krank-color);"></span> Krank</li>
                    <li><span class="border-example"></span> Feiertag</li>
                    <li><span class="half-border-example"></span> Halber FT</li>
                    <li style="margin-left: auto;">
                        <small>Δ Tgl. Saldo / Σ Lfd. Saldo</small>
                        <span class="positive-text" style="margin-left: 5px;">+</span>/<span class="negative-text">-</span>
                    </li>
                </ul>
            </div>
            <button id="colorSettingsBtn" title="Farben anpassen">⚙️</button>
         </div>

         <!-- Results Area -->
         <div id="results">
             <div class="results-summary">
                 <h2>Monatsbilanz</h2>
                 <p>Monatliches Soll: <span id="res_monatssoll">--:--</span> (<span id="res_werktage_anzahl">--</span> Tage)</p>
                 <p>Monatliches Haben: <span id="res_gutschrift_gesamt">--:--</span></p>
                 <p class="veraenderung">Veränderung Monat: <span id="res_veraenderung">--:--</span></p>
                 <hr style="border:0; border-top: 1px dashed #ccc; margin: 8px 0;">
                 <p class="endstand">Neuer Kontostand: <span id="res_endstand">--:--</span></p>
             </div>
             <div class="accordion-toggle" onclick="toggleAccordion(this)">Details anzeigen</div>
             <!-- Accordion Content -->
             <div class="accordion-content">
                 <p><strong class="detail-label">Basisdaten (<span id="res_detail_month_year">--</span>)</strong></p>
                 <p class="detail-item">AZK Vormonat (Eingabe): <span id="res_azk_vormonat_used">--:--</span></p>
                 <p class="detail-item">Arbeitspensum: <span id="res_prozent">--</span>%</p>
                 <p class="detail-item">Persönliches Tagessoll: <span id="res_tagessoll">--:--</span></p>
                 <p class="detail-item">Urlaubstage (an Soll-Tagen): <span id="res_urlaub_tage">--</span></p>
                 <p class="detail-item">Krankheitstage (an Soll-Tagen): <span id="res_krank_tage">--</span></p>
                 <hr>
                 <p><strong class="detail-label">Stundengutschrift Werktage (Mo-Fr, kein FT): <span id="res_detail_wd_total">--:--</span></strong></p>
                 <p class="detail-item">Frühdienste: <span id="res_detail_wd_f">--:--</span></p>
                 <p class="detail-item">M1-Dienste: <span id="res_detail_wd_m1">--:--</span></p>
                 <p class="detail-item">Spätdienste: <span id="res_detail_wd_s">--:--</span></p>
                 <p class="detail-item">Nachtdienste: <span id="res_detail_wd_n">--:--</span></p>
                 <hr>
                 <p><strong class="detail-label">Stundengutschrift Feiertage & Wochenende: <span id="res_detail_weft_total">--:--</span></strong></p>
                 <p class="detail-item">Frühdienste: <span id="res_detail_weft_f">--:--</span></p>
                 <p class="detail-item">M1-Dienste: <span id="res_detail_weft_m1">--:--</span></p>
                 <p class="detail-item">Spätdienste: <span id="res_detail_weft_s">--:--</span></p>
                 <p class="detail-item">Nachtdienste: <span id="res_detail_weft_n">--:--</span></p>
             </div>
         </div>

    </div> <!-- Ende .container -->

    <!-- Color Settings Modal -->
    <div id="colorSettingsModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeColorModal()">×</span>
            <h3>Farben anpassen</h3>
            <div class="color-picker-group">
                <label for="colorPicker-f">Früh:</label>
                <input type="color" id="colorPicker-f" data-var="--frueh-color">
                <span class="color-value-display" id="colorValue-f">#000000</span>
            </div>
            <div class="color-picker-group">
                <label for="colorPicker-m1">M1:</label>
                <input type="color" id="colorPicker-m1" data-var="--m1-color">
                <span class="color-value-display" id="colorValue-m1">#000000</span>
            </div>
             <div class="color-picker-group">
                <label for="colorPicker-s">Spät:</label>
                <input type="color" id="colorPicker-s" data-var="--spaet-color">
                <span class="color-value-display" id="colorValue-s">#000000</span>
            </div>
             <div class="color-picker-group">
                <label for="colorPicker-n">Nacht:</label>
                <input type="color" id="colorPicker-n" data-var="--nacht-color">
                <span class="color-value-display" id="colorValue-n">#000000</span>
            </div>
            <div class="color-picker-group">
                <label for="colorPicker-frei">Frei:</label>
                <input type="color" id="colorPicker-frei" data-var="--frei-color">
                <span class="color-value-display" id="colorValue-frei">#000000</span>
            </div>
            <div class="color-picker-group">
                <label for="colorPicker-urlaub">Urlaub:</label>
                <input type="color" id="colorPicker-urlaub" data-var="--urlaub-color">
                <span class="color-value-display" id="colorValue-urlaub">#000000</span>
            </div>
             <div class="color-picker-group">
                <label for="colorPicker-krank">Krank:</label>
                <input type="color" id="colorPicker-krank" data-var="--krank-color">
                <span class="color-value-display" id="colorValue-krank">#000000</span>
            </div>
            <hr style="margin: 15px 0;">
            <div class="color-picker-group">
                <label for="colorPicker-holiday">Feiertag (Rahmen):</label>
                <input type="color" id="colorPicker-holiday" data-var="--holiday-border-color">
                 <span class="color-value-display" id="colorValue-holiday">#000000</span>
            </div>
            <div class="color-picker-group">
                <label for="colorPicker-half-holiday">Halber FT (Rahmen):</label>
                <input type="color" id="colorPicker-half-holiday" data-var="--half-holiday-border-color">
                <span class="color-value-display" id="colorValue-half-holiday">#000000</span>
            </div>

            <div class="modal-actions">
                <button id="saveColorsBtn">Speichern</button>
                <button id="resetColorsBtn">Standard wiederherstellen</button>
                <button id="closeModalBtn" onclick="closeColorModal()">Schließen</button>
            </div>
        </div>
    </div>


    <script>
        // --- Konstanten ---
        const MINUTEN_FS_DIENST = 450; // 7h 30m (Früh, Spät, M1)
        const MINUTEN_NACHT_DIENST = 573; // 9h 33m
        const MINUTEN_BASIS_VOLLZEIT_WOCHE = 2310; // 38.5 * 60
        const TAGE_PRO_WOCHE = 5.0;
        const monthNames = ["Januar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
        const VALID_SHIFT_TYPES_FOR_JUMP = ['f', 'm1', 's', 'n', 'frei', 'urlaub', 'krank'];
        const LS_KEYS = {
            DATA: 'stundenkonto_dailyData',
            MONTH: 'stundenkonto_currentMonth',
            YEAR: 'stundenkonto_currentYear',
            AZK: 'stundenkonto_azkVormonat',
            PERCENT: 'stundenkonto_prozent',
            COLORS: 'stundenkonto_customColors' // NEW LS Key for colors
        };

        // --- Default Colors ---
        // Maps internal key to CSS variable name and default hex color
        const DEFAULT_COLORS = {
            'f': { varName: '--frueh-color', default: '#800020' },
            'm1': { varName: '--m1-color', default: '#17a2b8' },
            's': { varName: '--spaet-color', default: '#0056b3' },
            'n': { varName: '--nacht-color', default: '#6c757d' },
            'frei': { varName: '--frei-color', default: '#28a745' },
            'urlaub': { varName: '--urlaub-color', default: '#fd7e14' },
            'krank': { varName: '--krank-color', default: '#6f42c1' },
            'holiday': { varName: '--holiday-border-color', default: '#dc3545' },
            'half-holiday': { varName: '--half-holiday-border-color', default: '#ffc107' }
        };
        let currentColors = {}; // Holds the active color settings

        // --- Helper-Funktionen ---
        function formatDate(date) { /* ... (no changes needed) ... */ const d = new Date(date); const month = ('0' + (d.getMonth() + 1)).slice(-2); const day = ('0' + d.getDate()).slice(-2); const year = d.getFullYear(); return `${year}-${month}-${day}`; }
        function minutesToHHMM(totalMinutes) { /* ... (no changes needed) ... */ if (isNaN(totalMinutes) || totalMinutes === null) { return "--:--"; } const sign = totalMinutes < 0 ? "-" : ""; const absMinutes = Math.abs(totalMinutes); let hours = Math.floor(absMinutes / 60); let minutes = Math.round(absMinutes % 60); if (minutes === 60) { hours += 1; minutes = 0; } const formattedMinutes = String(minutes).padStart(2, '0'); return sign + hours + ":" + formattedMinutes; }

        // --- Validation ---
        function validateAzkFormat(timeString) { /* ... (no changes needed) ... */ if (timeString === null || timeString === undefined) return false; timeString = String(timeString).trim(); if (timeString === "") return true; const regex = /^(-?)(\d{1,})(?::)([0-5]\d)$/; const match = timeString.match(regex); return !!match; }
        function parseHHMMToMinutes(timeString) { /* ... (no changes needed) ... */ if (!validateAzkFormat(timeString)) { return 0; } timeString = String(timeString).trim(); if (timeString === "") return 0; const sign = timeString.startsWith('-') ? -1 : 1; const timePart = sign === -1 ? timeString.substring(1) : timeString; const parts = timePart.split(':'); if (parts.length !== 2) { return 0; } const hours = parseInt(parts[0], 10); const minutes = parseInt(parts[1], 10); if (isNaN(hours) || isNaN(minutes) || hours < 0 || minutes < 0 || minutes >= 60) { return 0; } return sign * ((hours * 60) + minutes); }

        // --- Feiertage ---
        function calculateEasterSunday(year) { /* ... (no changes needed) ... */ const a = year % 19; const b = Math.floor(year / 100); const c = year % 100; const d = Math.floor(b / 4); const e = b % 4; const f = Math.floor((b + 8) / 25); const g = Math.floor((b - f + 1) / 3); const h = (19 * a + b - d - g + 15) % 30; const i = Math.floor(c / 4); const k = c % 4; const l = (32 + 2 * e + 2 * i - h - k) % 7; const m = Math.floor((a + 11 * h + 22 * l) / 451); const month = Math.floor((h + l - 7 * m + 114) / 31); const day = ((h + l - 7 * m + 114) % 31) + 1; return new Date(year, month - 1, day); }
        function addDays(date, days) { /* ... (no changes needed) ... */ const result = new Date(date); result.setDate(result.getDate() + days); return result; }
        const holidaysBY = new Set();
        function populateHolidays(years) { /* ... (no changes needed) ... */ holidaysBY.clear(); years.forEach(year => { holidaysBY.add(`${year}-01-01`); holidaysBY.add(`${year}-01-06`); holidaysBY.add(`${year}-05-01`); holidaysBY.add(`${year}-08-15`); holidaysBY.add(`${year}-10-03`); holidaysBY.add(`${year}-11-01`); holidaysBY.add(`${year}-12-25`); holidaysBY.add(`${year}-12-26`); const easterSunday = calculateEasterSunday(year); holidaysBY.add(formatDate(addDays(easterSunday, -2))); holidaysBY.add(formatDate(addDays(easterSunday, 1))); holidaysBY.add(formatDate(addDays(easterSunday, 39))); holidaysBY.add(formatDate(addDays(easterSunday, 50))); holidaysBY.add(formatDate(addDays(easterSunday, 60))); }); }
        populateHolidays([new Date().getFullYear() -1, new Date().getFullYear(), new Date().getFullYear() + 1]); // Initial years
        function isHoliday(dateStr) { /* ... (no changes needed) ... */ return holidaysBY.has(dateStr); }
        function isHalfDayHoliday(dateStr) { /* ... (no changes needed) ... */ const year = parseInt(dateStr.substring(0, 4), 10); const monthDay = dateStr.substring(5); if (monthDay === '12-24') { return true; } const easterSunday = calculateEasterSunday(year); const shroveTuesday = addDays(easterSunday, -47); if (dateStr === formatDate(shroveTuesday)) { return true; } return false; }

        // --- Local Storage ---
        function saveDataToLocalStorage() {
            try {
                localStorage.setItem(LS_KEYS.DATA, JSON.stringify(dailyData));
                localStorage.setItem(LS_KEYS.MONTH, currentMonth.toString());
                localStorage.setItem(LS_KEYS.YEAR, currentYear.toString());
                localStorage.setItem(LS_KEYS.AZK, azkVormonatInput.value);
                localStorage.setItem(LS_KEYS.PERCENT, prozentInput.value);
                // Save colors only if they are different from default
                const customColorsToSave = {};
                let hasCustom = false;
                for (const key in currentColors) {
                    if (currentColors[key] !== DEFAULT_COLORS[key]?.default) {
                        customColorsToSave[key] = currentColors[key];
                        hasCustom = true;
                    }
                }
                if (hasCustom) {
                     localStorage.setItem(LS_KEYS.COLORS, JSON.stringify(customColorsToSave));
                } else {
                    localStorage.removeItem(LS_KEYS.COLORS); // Remove if all are default
                }
            } catch (e) { console.error("Fehler beim Speichern im localStorage:", e); }
        }
        function loadDataFromLocalStorage() {
            try {
                const storedData = localStorage.getItem(LS_KEYS.DATA);
                const storedMonth = localStorage.getItem(LS_KEYS.MONTH);
                const storedYear = localStorage.getItem(LS_KEYS.YEAR);
                const storedAzk = localStorage.getItem(LS_KEYS.AZK);
                const storedPercent = localStorage.getItem(LS_KEYS.PERCENT);
                const storedColors = localStorage.getItem(LS_KEYS.COLORS); // Load colors

                if (storedData) { dailyData = JSON.parse(storedData); }
                currentMonth = storedMonth !== null ? parseInt(storedMonth, 10) : new Date().getMonth();
                currentYear = storedYear !== null ? parseInt(storedYear, 10) : new Date().getFullYear();
                if (isNaN(currentMonth) || currentMonth < 0 || currentMonth > 11) currentMonth = new Date().getMonth();
                if (isNaN(currentYear) ) currentYear = new Date().getFullYear();
                azkVormonatInput.value = storedAzk || "";
                prozentInput.value = storedPercent || "100.0";
                prozentSlider.value = Math.round(parseFloat(prozentInput.value) || 100); // Sync slider on load

                 // Load and apply colors
                loadAndApplyColors(storedColors);

            } catch (e) {
                console.error("Fehler beim Laden aus dem localStorage:", e);
                dailyData = {};
                currentMonth = new Date().getMonth();
                currentYear = new Date().getFullYear();
                azkVormonatInput.value = "";
                prozentInput.value = "100.0";
                prozentSlider.value = 100;
                loadAndApplyColors(null); // Apply default colors on error
            }
        }

        // --- Color Management --- NEW ---
        function loadAndApplyColors(storedColorsJSON) {
            let loadedCustomColors = {};
            if (storedColorsJSON) {
                try {
                    loadedCustomColors = JSON.parse(storedColorsJSON);
                } catch (e) {
                    console.error("Fehler beim Parsen der gespeicherten Farben:", e);
                    loadedCustomColors = {}; // Use defaults if parsing fails
                }
            }

            // Merge defaults with loaded custom colors
            currentColors = {};
            for (const key in DEFAULT_COLORS) {
                currentColors[key] = loadedCustomColors[key] || DEFAULT_COLORS[key].default;
            }
            applyColorsToDOM(currentColors);
        }

        function applyColorsToDOM(colorSettings) {
            const rootStyle = document.documentElement.style;
            for (const key in colorSettings) {
                if (DEFAULT_COLORS[key]) { // Ensure the key is valid
                    rootStyle.setProperty(DEFAULT_COLORS[key].varName, colorSettings[key]);
                }
            }
        }

        function openColorModal() {
            populateColorPickers();
            document.getElementById('colorSettingsModal').style.display = 'block';
        }

        function closeColorModal() {
            document.getElementById('colorSettingsModal').style.display = 'none';
        }

        function populateColorPickers() {
            for (const key in currentColors) {
                const picker = document.getElementById(`colorPicker-${key}`);
                const valueDisplay = document.getElementById(`colorValue-${key}`);
                if (picker) {
                    picker.value = currentColors[key];
                }
                 if (valueDisplay) {
                     valueDisplay.textContent = currentColors[key];
                     // Optionally set text color for better contrast preview? Maybe too complex.
                     // valueDisplay.style.color = isColorDark(currentColors[key]) ? '#eee' : '#333';
                 }
            }
            // Add listeners to update hex display dynamically
             document.querySelectorAll('#colorSettingsModal input[type="color"]').forEach(picker => {
                picker.removeEventListener('input', updateColorValueDisplay); // Prevent duplicates
                picker.addEventListener('input', updateColorValueDisplay);
            });
        }

        function updateColorValueDisplay(event) {
             const picker = event.target;
             const key = picker.id.replace('colorPicker-', '');
             const valueDisplay = document.getElementById(`colorValue-${key}`);
             if (valueDisplay) {
                 valueDisplay.textContent = picker.value;
             }
         }


        function saveColors() {
            const newColors = {};
            for (const key in DEFAULT_COLORS) {
                 const picker = document.getElementById(`colorPicker-${key}`);
                 if (picker) {
                     newColors[key] = picker.value;
                 } else {
                      newColors[key] = currentColors[key]; // Fallback if picker not found
                 }
            }
            currentColors = newColors;
            applyColorsToDOM(currentColors);
            saveDataToLocalStorage(); // Save all data including the new colors
            closeColorModal();
            // Optional: Force calendar redraw if needed, though CSS vars should apply live
            // recalculateIfValid();
        }

        function resetColorsToDefault() {
            currentColors = {};
             for (const key in DEFAULT_COLORS) {
                 currentColors[key] = DEFAULT_COLORS[key].default;
             }
            applyColorsToDOM(currentColors);
            populateColorPickers(); // Update pickers in the modal to show defaults
            saveDataToLocalStorage(); // Save removal of custom colors
            // Optional: Force calendar redraw if needed
            // recalculateIfValid();
        }


        // --- Globals ---
        let currentYear, currentMonth;
        let dailyData = {};
        let selectedDate = null; let showDailyBalance = false;

        // --- DOM Elements ---
        const monthSelect = document.getElementById('month'); const yearSelect = document.getElementById('year');
        const calendarBody = document.getElementById('calendar-body');
        const prozentInput = document.getElementById('prozent');
        const prozentSlider = document.getElementById('prozentSlider'); // NEW Slider Element
        const prozentValueDisplay = document.getElementById('prozentValueDisplay');
        const dayActionsDiv = document.getElementById('day-actions'); const selectedDaySpan = document.getElementById('selected-day-display');
        const resultsDiv = document.getElementById('results'); const accordionContent = document.querySelector('.accordion-content');
        const toggleBalanceBtn = document.getElementById('toggleBalanceBtn'); const azkVormonatInput = document.getElementById('azk_vormonat');
        const azkErrorSpan = document.getElementById('azk_error');
        // Color Modal Elements
        const colorSettingsBtn = document.getElementById('colorSettingsBtn');
        const colorSettingsModal = document.getElementById('colorSettingsModal');
        const saveColorsBtn = document.getElementById('saveColorsBtn');
        const resetColorsBtn = document.getElementById('resetColorsBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');


        // --- Input Formatting ---
        function formatAzkInput(event) { /* ... (no changes needed) ... */ const input = event.target; let value = input.value; let originalLength = value.length; let cursorPosition = input.selectionStart; let isNegative = value.startsWith('-'); let digits = value.replace(/[^\d]/g, ''); const maxLength = 4; if (digits.length > maxLength) { digits = digits.slice(0, maxLength); } let formattedValue = isNegative ? "-" : ""; if (digits.length === 0) { formattedValue = isNegative ? "-" : ""; } else if (digits.length <= 2) { formattedValue += digits; if(digits.length == 2 && !value.includes(':') && !(isNegative && formattedValue.length == 3)) { formattedValue += ":"; } } else { let hours = digits.slice(0, digits.length - 2); let minutes = digits.slice(digits.length - 2); if (parseInt(minutes, 10) > 59) { minutes = "59"; } formattedValue += hours + ":" + minutes; } if (input.value !== formattedValue) { input.value = formattedValue; let lengthDiff = formattedValue.length - originalLength; let newCursorPosition = cursorPosition + lengthDiff; if (lengthDiff === 1 && originalLength >= (isNegative ? 3 : 2) && formattedValue.charAt(newCursorPosition -1) === ':') {} else if (lengthDiff === 1 && originalLength >= (isNegative ? 1 : 0) && digits.length === 2) { newCursorPosition = formattedValue.length; } else if (lengthDiff < 0 && value.charAt(cursorPosition) === ':') { newCursorPosition = cursorPosition -1; } if (newCursorPosition < 0) newCursorPosition = 0; if (newCursorPosition > formattedValue.length) newCursorPosition = formattedValue.length; try { setTimeout(() => { input.setSelectionRange(newCursorPosition, newCursorPosition); }, 0); } catch (e) { console.warn("Cursor position could not be set reliably."); } } handleAzkInputValidation(); }
        function handleAzkInputValidation() { /* ... (no changes needed) ... */ const value = azkVormonatInput.value; const isValidFinal = validateAzkFormat(value); azkErrorSpan.textContent = (!isValidFinal && value !== "" && value !== "-") ? 'Format: Std:Min' : ''; azkVormonatInput.setCustomValidity((isValidFinal || value === "") ? '' : 'Ungültiges Format. Erwartet: HH:MM oder -HH:MM'); azkVormonatInput.setAttribute('aria-invalid', !(isValidFinal || value === "")); }

        // --- Prozent Input/Slider Handling --- UPDATED ---
        function handleProzentInput() {
            let value = parseFloat(prozentInput.value);
            if (isNaN(value)) {
                 prozentValueDisplay.textContent = "%";
                 // Don't sync slider if input is invalid during typing
                 return;
            }
            value = Math.max(0, Math.min(100, value));
            prozentValueDisplay.textContent = value.toFixed(1) + "%";
            // Sync slider (use rounded value for integer steps)
            prozentSlider.value = Math.round(value);
         }

         function handleProzentSliderInput() {
             const value = parseInt(prozentSlider.value, 10); // Slider gives integer
             prozentInput.value = value.toFixed(1); // Update number input (with .0)
             prozentValueDisplay.textContent = value.toFixed(1) + "%";
             // Trigger recalculation immediately on slider change
             recalculateIfValid();
         }

        function finalizeProzentInput() {
            let value = parseFloat(prozentInput.value);
            if (isNaN(value)) { value = 100.0; }
            value = Math.max(0, Math.min(100, value));
            prozentInput.value = value.toFixed(1);
            prozentSlider.value = Math.round(value); // Final sync of slider
            prozentValueDisplay.textContent = value.toFixed(1) + "%";
            // Recalculate when number input *loses focus* or is finalized
            // recalculateIfValid(); // This is already called by the 'change' listener
         }

        // --- Init & Core Logic ---
         function init() {
              loadDataFromLocalStorage(); // Loads data, percent, AND colors now
              populateYearSelector();
              populateMonthSelector();

              // Sync display initially based on potentially loaded/defaulted value
              handleProzentInput(); // Handles display and slider sync based on prozentInput value

              // --- Event Listeners ---
              monthSelect.addEventListener('change', () => { currentMonth = parseInt(monthSelect.value); recalculateIfValid(); });
              yearSelect.addEventListener('change', () => { currentYear = parseInt(yearSelect.value); const yearsToCheck = [currentYear -1, currentYear, currentYear + 1]; const needsUpdate = yearsToCheck.some(y => !holidaysBY.has(`${y}-01-01`)); if (needsUpdate) { populateHolidays(yearsToCheck); } recalculateIfValid(); });
              azkVormonatInput.addEventListener('input', formatAzkInput);
              azkVormonatInput.addEventListener('change', recalculateIfValid); // Recalc on blur/enter

              // Percent Input/Slider Listeners
              prozentInput.addEventListener('input', handleProzentInput); // Update display/slider while typing
              prozentInput.addEventListener('change', () => { finalizeProzentInput(); recalculateIfValid(); }); // Finalize format and recalc on blur/enter
              prozentSlider.addEventListener('input', handleProzentSliderInput); // Update input/display AND recalc *while sliding*

              // Color Settings Listeners
              colorSettingsBtn.addEventListener('click', openColorModal);
              saveColorsBtn.addEventListener('click', saveColors);
              resetColorsBtn.addEventListener('click', resetColorsToDefault);
              // Close modal if clicking outside of it
              window.addEventListener('click', (event) => { if (event.target == colorSettingsModal) { closeColorModal(); } });


              recalculateIfValid(); // Initial calculation after setup

              // Global click listener for deselecting day
              document.addEventListener('click', (event) => {
                  const calendar = document.getElementById('calendar');
                  const actions = document.getElementById('day-actions');
                  const colorModal = document.getElementById('colorSettingsModal'); // Check modal too
                  const targetElement = event.target;
                  const isClickInsideCalendar = calendar.contains(targetElement) || targetElement.closest('td[data-date]');
                  const isClickInsideActions = actions.contains(targetElement);
                  const isClickInsideModal = colorModal.contains(targetElement) || targetElement === colorSettingsBtn; // Check modal trigger too
                  const isControlElement = targetElement.closest('.controls') || targetElement.closest('.percent-control') || targetElement.id === 'exportPdfBtn';

                  if (!isClickInsideCalendar && !isClickInsideActions && !isControlElement && !isClickInsideModal) {
                      deselectDay();
                  }
              });
         }
         function recalculateIfValid() {
             handleAzkInputValidation(); // Check AZK format first
             // finalizeProzentInput(); // Ensure percent is formatted, already called by change listener
             const isAzkValid = validateAzkFormat(azkVormonatInput.value);

             if (isAzkValid) {
                 loadCalendar(currentYear, currentMonth);
                 saveDataToLocalStorage(); // Save changes
             } else {
                 // Don't clear calendar if only percent was invalid, but AZK is still an issue
                 if (!document.querySelector('#calendar-body td')) { // Only show message if calendar is empty
                     resultsDiv.style.display = 'none';
                     calendarBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: var(--danger-color);">Bitte gültiges Format für AZK Vormonat eingeben (Std:Min oder -Std:Min).</td></tr>';
                     deselectDay();
                }
             }
         }
         function populateYearSelector() { /* ... (no changes needed) ... */ const currentFullYear = new Date().getFullYear(); for (let i = currentFullYear - 10; i <= currentFullYear + 5; i++) { const option = document.createElement('option'); option.value = i; option.textContent = i; if (i === currentYear) option.selected = true; yearSelect.appendChild(option); } }
         function populateMonthSelector() { /* ... (no changes needed) ... */ monthNames.forEach((name, index) => { const option = document.createElement('option'); option.value = index; option.textContent = name; if (index === currentMonth) option.selected = true; monthSelect.appendChild(option); }); }

        // --- Calendar Logic ---
        function loadCalendar(year, month) {
             calendarBody.innerHTML = ''; resultsDiv.style.display = 'none'; accordionContent.style.display = 'none'; document.querySelector('.accordion-toggle').textContent = 'Details anzeigen'; document.querySelector('.accordion-toggle').classList.remove('open'); deselectDay();
             const startBalanceMinutes = parseHHMMToMinutes(azkVormonatInput.value);
             const prozent = parseFloat(prozentInput.value); // Use the number input's value
             if (isNaN(prozent)) {
                calendarBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: var(--danger-color);">Ungültiger Prozentwert für Arbeitszeit.</td></tr>';
                return;
             }
             const tagessoll_minuten_full = Math.round((prozent / 100.0) * (MINUTEN_BASIS_VOLLZEIT_WOCHE / TAGE_PRO_WOCHE));
             const firstDayOfMonth = new Date(year, month, 1); const lastDayOfMonth = new Date(year, month + 1, 0); const daysInMonth = lastDayOfMonth.getDate(); const startDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7;
             let date = 1; const todayStr = formatDate(new Date()); let runningBalanceMinutes = startBalanceMinutes;
             for (let i = 0; i < 6; i++) {
                 const row = document.createElement('tr');
                 for (let j = 0; j < 7; j++) {
                     const cell = document.createElement('td');
                     if ((i === 0 && j < startDayOfWeek) || date > daysInMonth) { cell.classList.add('other-month'); }
                     else {
                         const currentDateObj = new Date(year, month, date); const currentDateStr = formatDate(currentDateObj); const dayOfWeek = currentDateObj.getDay(); const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; const isFullHoliday = isHoliday(currentDateStr); const isHalfHoliday = !isFullHoliday && isHalfDayHoliday(currentDateStr);
                         cell.dataset.date = currentDateStr; cell.innerHTML = `<span class="day-number">${date}</span><span class="day-shift"></span><div class="day-balance-container"><span class="day-balance"></span><span class="day-running-balance"></span></div>`;
                         cell.onclick = (event) => { event.stopPropagation(); selectDay(cell, currentDateStr); };
                         if (currentDateStr === todayStr) cell.classList.add('today'); if (isWeekend) cell.classList.add('weekend'); if (isFullHoliday) cell.classList.add('holiday'); if (isHalfHoliday) cell.classList.add('half-holiday');
                         const dayInfo = dailyData[currentDateStr]; updateDayDisplay(cell, dayInfo, tagessoll_minuten_full, runningBalanceMinutes, isFullHoliday, isHalfHoliday);
                         let dailyTarget_minuten = 0; const isWorkdayForSollCalculation = !isWeekend && !isFullHoliday; const isWorkday = dayOfWeek >= 1 && dayOfWeek <= 5;
                         if (isWorkdayForSollCalculation) { dailyTarget_minuten = (isHalfHoliday && isWorkday) ? Math.round(tagessoll_minuten_full / 2) : tagessoll_minuten_full; }
                         let dailyCredit_minuten = 0; const shiftType = dayInfo?.shift;
                         if (shiftType === 'f' || shiftType === 's' || shiftType === 'm1') dailyCredit_minuten = MINUTEN_FS_DIENST;
                         else if (shiftType === 'n') dailyCredit_minuten = MINUTEN_NACHT_DIENST;
                         else if (shiftType === 'urlaub' && isWorkdayForSollCalculation) { dailyCredit_minuten = tagessoll_minuten_full; }
                         else if (shiftType === 'krank' && isWorkdayForSollCalculation) { dailyCredit_minuten = tagessoll_minuten_full; } // Krank Credit
                         const dailyBalance_minuten = dailyCredit_minuten - dailyTarget_minuten; runningBalanceMinutes += dailyBalance_minuten;
                         date++;
                     }
                     row.appendChild(cell);
                 }
                 calendarBody.appendChild(row); if (date > daysInMonth && i >= Math.ceil((startDayOfWeek + daysInMonth) / 7) - 1) break;
             }
             calculateMonthlyBalance(); // Calculate and display results
         }
        function deselectDay() { /* ... (no changes needed) ... */ const prevSelected = document.querySelector('#calendar td.selected'); if (prevSelected) prevSelected.classList.remove('selected'); selectedDate = null; dayActionsDiv.style.display = 'none'; selectedDaySpan.textContent = '--.--.----'; }
        function selectDay(cell, dateStr) { /* ... (no changes needed) ... */ if (cell.classList.contains('other-month')) return; deselectDay(); cell.classList.add('selected'); selectedDate = dateStr; selectedDaySpan.textContent = new Date(dateStr).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }); updateActionButtonsUI(dailyData[selectedDate]); dayActionsDiv.style.display = 'block'; setTimeout(() => { dayActionsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 50); }
        function updateActionButtonsUI(dayInfo) { /* ... (no changes needed) ... */ const currentShift = dayInfo?.shift; document.querySelectorAll('#day-actions button[data-shift]').forEach(btn => { btn.classList.toggle('active', btn.dataset.shift === currentShift); }); }
        function assignShift(shiftType) { /* ... (no changes needed) ... */ if (!selectedDate) return; const originalDateStr = selectedDate; if (shiftType === null) { delete dailyData[originalDateStr]; } else { if (!dailyData[originalDateStr]) { dailyData[originalDateStr] = {}; } dailyData[originalDateStr].shift = shiftType; } recalculateIfValid(); setTimeout(() => { const originalCell = document.querySelector(`#calendar td[data-date="${originalDateStr}"]`); if (!originalCell || originalCell.closest('tbody') !== calendarBody) { deselectDay(); return; } if (VALID_SHIFT_TYPES_FOR_JUMP.includes(shiftType)) { const currentDate = new Date(originalDateStr); currentDate.setDate(currentDate.getDate() + 1); const nextDateStr = formatDate(currentDate); const nextCell = document.querySelector(`#calendar td[data-date="${nextDateStr}"]`); if (nextCell && !nextCell.classList.contains('other-month')) { selectDay(nextCell, nextDateStr); } else { deselectDay(); } } else { selectDay(originalCell, originalDateStr); } }, 50); }
        function updateDayDisplay(cell, dayInfo, tagessoll_minuten_full, runningBalanceStartOfDay_minuten, isFullHoliday, isHalfHoliday) { /* ... (no changes needed) ... */ const shiftSpan = cell.querySelector('.day-shift'); const balanceSpan = cell.querySelector('.day-balance'); const runningBalanceSpan = cell.querySelector('.day-running-balance'); if (!shiftSpan || !balanceSpan || !runningBalanceSpan) return; const shiftType = dayInfo?.shift; shiftSpan.className = 'day-shift'; shiftSpan.textContent = ''; if (shiftType) { shiftSpan.classList.add(`shift-${shiftType}`); shiftSpan.textContent = getShiftText(shiftType); } cell.title = ''; if (isFullHoliday) cell.title = 'Feiertag'; if (isHalfHoliday) cell.title = 'Halber Feiertag'; balanceSpan.textContent = ''; balanceSpan.className = 'day-balance'; runningBalanceSpan.textContent = ''; runningBalanceSpan.className = 'day-running-balance'; if (showDailyBalance) { const dateStr = cell.dataset.date; const dayOfWeek = new Date(dateStr).getDay(); const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; let dailyTarget_minuten = 0; const isWorkdayForSollCalculation = !isWeekend && !isFullHoliday; const isWorkday = dayOfWeek >= 1 && dayOfWeek <= 5; if (isWorkdayForSollCalculation) { dailyTarget_minuten = (isHalfHoliday && isWorkday) ? Math.round(tagessoll_minuten_full / 2) : tagessoll_minuten_full; } let dailyCredit_minuten = 0; if (shiftType === 'f' || shiftType === 's' || shiftType === 'm1') dailyCredit_minuten = MINUTEN_FS_DIENST; else if (shiftType === 'n') dailyCredit_minuten = MINUTEN_NACHT_DIENST; else if (shiftType === 'urlaub' && isWorkdayForSollCalculation) { dailyCredit_minuten = tagessoll_minuten_full; } else if (shiftType === 'krank' && isWorkdayForSollCalculation) { dailyCredit_minuten = tagessoll_minuten_full; } const dailyBalance_minuten = dailyCredit_minuten - dailyTarget_minuten; if (dailyBalance_minuten !== 0 || shiftType) { balanceSpan.textContent = "Δ " + minutesToHHMM(dailyBalance_minuten); balanceSpan.classList.add(dailyBalance_minuten >= 0 ? 'balance-positive' : 'balance-negative'); } const runningBalanceEndOfDay_minuten = runningBalanceStartOfDay_minuten + dailyBalance_minuten; runningBalanceSpan.textContent = "Σ " + minutesToHHMM(runningBalanceEndOfDay_minuten); runningBalanceSpan.classList.add(runningBalanceEndOfDay_minuten >= 0 ? 'balance-positive' : 'balance-negative'); } }
        function toggleDailyBalanceDisplay() { /* ... (no changes needed) ... */ showDailyBalance = !showDailyBalance; toggleBalanceBtn.textContent = showDailyBalance ? 'Saldo Verbergen' : 'Saldo Anzeigen'; recalculateIfValid(); const previouslySelectedDate = selectedDate; if (previouslySelectedDate) { setTimeout(() => { const cell = document.querySelector(`#calendar td[data-date="${previouslySelectedDate}"]`); if (cell && cell.closest('tbody') === calendarBody) { selectDay(cell, previouslySelectedDate); } else { deselectDay(); } }, 50); } }

        // --- Calculations & Display ---
        function calculateMonthlyBalance() { /* ... (no changes, but uses prozentInput.value) ... */
             const startBalanceMinutes = parseHHMMToMinutes(azkVormonatInput.value);
             const prozent = parseFloat(prozentInput.value); // Use the number input value here
             if (isNaN(prozent)) {
                 console.error("Invalid percentage value in calculation.");
                 resultsDiv.style.display = 'none'; // Hide results if percent is bad
                 return;
             }
             const year = parseInt(yearSelect.value); const month = parseInt(monthSelect.value); const tagessoll_minuten_full = Math.round((prozent / 100.0) * (MINUTEN_BASIS_VOLLZEIT_WOCHE / TAGE_PRO_WOCHE)); const tagessoll_minuten_half = Math.round(tagessoll_minuten_full / 2);
             let monatssoll_minuten = 0; let gutschrift_gesamt_minuten = 0; let urlaub_tage_anzahl = 0; let krank_tage_anzahl = 0; let werktage_im_monat_fuer_soll_count = 0;
             let gutschrift_wd_f = 0, gutschrift_wd_m1 = 0, gutschrift_wd_s = 0, gutschrift_wd_n = 0; let gutschrift_weft_f = 0, gutschrift_weft_m1 = 0, gutschrift_weft_s = 0, gutschrift_weft_n = 0;
             const daysInMonth = new Date(year, month + 1, 0).getDate();
             for (let day = 1; day <= daysInMonth; day++) {
                 const currentDateObj = new Date(year, month, day); const currentDateStr = formatDate(currentDateObj); const dayOfWeek = currentDateObj.getDay(); const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; const isFullHoliday = isHoliday(currentDateStr); const isHalfHoliday = !isFullHoliday && isHalfDayHoliday(currentDateStr); const dayInfo = dailyData[currentDateStr]; const shift = dayInfo?.shift;
                 let dailyTarget_minuten = 0; const isPotentialWorkday = !isWeekend && !isFullHoliday; const isWorkday = dayOfWeek >= 1 && dayOfWeek <= 5;
                 if(isPotentialWorkday) { if(isHalfHoliday && isWorkday) { dailyTarget_minuten = tagessoll_minuten_half; werktage_im_monat_fuer_soll_count += 0.5; } else { dailyTarget_minuten = tagessoll_minuten_full; werktage_im_monat_fuer_soll_count += 1.0; } } monatssoll_minuten += dailyTarget_minuten;
                 let dailyCredit_minuten = 0; let isWorkdayCredit = isPotentialWorkday && !(isHalfHoliday && isWorkday); let isWEFTHolidayCredit = isWeekend || isFullHoliday || (isHalfHoliday && isWorkday);
                 if (shift === 'f') { dailyCredit_minuten = MINUTEN_FS_DIENST; if (isWorkdayCredit) gutschrift_wd_f += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_f += dailyCredit_minuten; }
                 else if (shift === 'm1') { dailyCredit_minuten = MINUTEN_FS_DIENST; if (isWorkdayCredit) gutschrift_wd_m1 += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_m1 += dailyCredit_minuten; }
                 else if (shift === 's') { dailyCredit_minuten = MINUTEN_FS_DIENST; if (isWorkdayCredit) gutschrift_wd_s += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_s += dailyCredit_minuten; }
                 else if (shift === 'n') { dailyCredit_minuten = MINUTEN_NACHT_DIENST; if (isWorkdayCredit) gutschrift_wd_n += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_n += dailyCredit_minuten; }
                 else if (shift === 'urlaub') { if (isPotentialWorkday) { dailyCredit_minuten = tagessoll_minuten_full; urlaub_tage_anzahl++; } }
                 else if (shift === 'krank') { if (isPotentialWorkday) { dailyCredit_minuten = tagessoll_minuten_full; krank_tage_anzahl++; } }
                 gutschrift_gesamt_minuten += dailyCredit_minuten;
             }
             const veraenderung_minuten = gutschrift_gesamt_minuten - monatssoll_minuten; const endstand_minuten = startBalanceMinutes + veraenderung_minuten; const total_wd_credit = gutschrift_wd_f + gutschrift_wd_m1 + gutschrift_wd_s + gutschrift_wd_n; const total_weft_credit = gutschrift_weft_f + gutschrift_weft_m1 + gutschrift_weft_s + gutschrift_weft_n;
             document.getElementById('res_monatssoll').textContent = minutesToHHMM(monatssoll_minuten); document.getElementById('res_werktage_anzahl').textContent = werktage_im_monat_fuer_soll_count.toFixed(1).replace('.0', ''); document.getElementById('res_gutschrift_gesamt').textContent = minutesToHHMM(gutschrift_gesamt_minuten); const veraenderungElement = document.getElementById('res_veraenderung'); veraenderungElement.textContent = minutesToHHMM(veraenderung_minuten); veraenderungElement.parentElement.className = 'veraenderung ' + (veraenderung_minuten >= 0 ? 'positive' : 'negative'); const endstandElement = document.getElementById('res_endstand'); endstandElement.textContent = minutesToHHMM(endstand_minuten); endstandElement.parentElement.className = 'endstand ' + (endstand_minuten >= 0 ? 'positive' : 'negative');
             document.getElementById('res_detail_month_year').textContent = `${monthNames[month]} ${year}`; document.getElementById('res_azk_vormonat_used').textContent = minutesToHHMM(startBalanceMinutes); document.getElementById('res_prozent').textContent = prozent.toFixed(1); document.getElementById('res_tagessoll').textContent = minutesToHHMM(tagessoll_minuten_full);
             document.getElementById('res_urlaub_tage').textContent = urlaub_tage_anzahl;
             document.getElementById('res_krank_tage').textContent = krank_tage_anzahl;
             document.getElementById('res_detail_wd_total').textContent = minutesToHHMM(total_wd_credit); document.getElementById('res_detail_wd_f').textContent = minutesToHHMM(gutschrift_wd_f); document.getElementById('res_detail_wd_m1').textContent = minutesToHHMM(gutschrift_wd_m1); document.getElementById('res_detail_wd_s').textContent = minutesToHHMM(gutschrift_wd_s); document.getElementById('res_detail_wd_n').textContent = minutesToHHMM(gutschrift_wd_n);
             document.getElementById('res_detail_weft_total').textContent = minutesToHHMM(total_weft_credit); document.getElementById('res_detail_weft_f').textContent = minutesToHHMM(gutschrift_weft_f); document.getElementById('res_detail_weft_m1').textContent = minutesToHHMM(gutschrift_weft_m1); document.getElementById('res_detail_weft_s').textContent = minutesToHHMM(gutschrift_weft_s); document.getElementById('res_detail_weft_n').textContent = minutesToHHMM(gutschrift_weft_n);
             resultsDiv.style.display = 'block';
         }
        function toggleAccordion(toggleElement) { /* ... (no changes needed) ... */ const content = accordionContent; const isOpen = content.style.display === "block"; content.style.display = isOpen ? "none" : "block"; toggleElement.textContent = isOpen ? 'Details verbergen' : 'Details anzeigen'; toggleElement.classList.toggle('open', !isOpen); }

        // --- PDF Export ---
        // NOTE: PDF Export currently DOES NOT use the custom colors.
        // It would require significant changes to pass color info into jsPDF styles.
        function exportToPDF() { /* ... (no changes needed in basic functionality, but does NOT use custom colors) ... */
            if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') { alert("jsPDF konnte nicht geladen werden. Bitte Seite neu laden."); return; }
            const { jsPDF } = jspdf; const doc = new jsPDF(); if (typeof doc.autoTable !== 'function') { alert("jsPDF-AutoTable konnte nicht geladen werden. Bitte Seite neu laden."); console.error("Fehler: doc.autoTable ist keine Funktion."); return; }
            const startBalanceMinutes = parseHHMMToMinutes(azkVormonatInput.value); const prozent = parseFloat(prozentInput.value); if (isNaN(prozent)) { alert("Ungültiger Prozentwert."); return; }
            const year = parseInt(yearSelect.value); const month = parseInt(monthSelect.value); const tagessoll_minuten_full = Math.round((prozent / 100.0) * (MINUTEN_BASIS_VOLLZEIT_WOCHE / TAGE_PRO_WOCHE)); const tagessoll_minuten_half = Math.round(tagessoll_minuten_full / 2);
            let monatssoll_minuten = 0; let gutschrift_gesamt_minuten = 0; let urlaub_tage_anzahl = 0; let krank_tage_anzahl = 0; let werktage_im_monat_fuer_soll_count = 0; let gutschrift_wd_f = 0, gutschrift_wd_m1 = 0, gutschrift_wd_s = 0, gutschrift_wd_n = 0; let gutschrift_weft_f = 0, gutschrift_weft_m1 = 0, gutschrift_weft_s = 0, gutschrift_weft_n = 0; const daysInMonth = new Date(year, month + 1, 0).getDate(); let dailyDetailsForPDF = []; let runningBalancePDF = startBalanceMinutes;
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDateObj = new Date(year, month, day); const currentDateStr = formatDate(currentDateObj); const dayOfWeek = currentDateObj.getDay(); const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; const isFullHoliday = isHoliday(currentDateStr); const isHalfHoliday = !isFullHoliday && isHalfDayHoliday(currentDateStr); const dayInfo = dailyData[currentDateStr]; const shift = dayInfo?.shift;
                let dailyTarget_minuten = 0; const isPotentialWorkday = !isWeekend && !isFullHoliday; const isWorkday = dayOfWeek >= 1 && dayOfWeek <= 5;
                if(isPotentialWorkday) { if(isHalfHoliday && isWorkday) { dailyTarget_minuten = tagessoll_minuten_half; werktage_im_monat_fuer_soll_count += 0.5; } else { dailyTarget_minuten = tagessoll_minuten_full; werktage_im_monat_fuer_soll_count += 1.0; } } monatssoll_minuten += dailyTarget_minuten;
                let dailyCredit_minuten = 0; let isWorkdayCredit = isPotentialWorkday && !(isHalfHoliday && isWorkday); let isWEFTHolidayCredit = isWeekend || isFullHoliday || (isHalfHoliday && isWorkday); let shiftText = shift ? getShiftText(shift) : "-";
                if (shift === 'f') { dailyCredit_minuten = MINUTEN_FS_DIENST; if (isWorkdayCredit) gutschrift_wd_f += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_f += dailyCredit_minuten; }
                else if (shift === 'm1') { dailyCredit_minuten = MINUTEN_FS_DIENST; if (isWorkdayCredit) gutschrift_wd_m1 += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_m1 += dailyCredit_minuten; }
                else if (shift === 's') { dailyCredit_minuten = MINUTEN_FS_DIENST; if (isWorkdayCredit) gutschrift_wd_s += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_s += dailyCredit_minuten; }
                else if (shift === 'n') { dailyCredit_minuten = MINUTEN_NACHT_DIENST; if (isWorkdayCredit) gutschrift_wd_n += dailyCredit_minuten; else if (isWEFTHolidayCredit) gutschrift_weft_n += dailyCredit_minuten; }
                else if (shift === 'urlaub') { if (isPotentialWorkday) { dailyCredit_minuten = tagessoll_minuten_full; urlaub_tage_anzahl++; } }
                else if (shift === 'krank') { if (isPotentialWorkday) { dailyCredit_minuten = tagessoll_minuten_full; krank_tage_anzahl++; } }
                gutschrift_gesamt_minuten += dailyCredit_minuten; const dailyBalance_minuten = dailyCredit_minuten - dailyTarget_minuten; runningBalancePDF += dailyBalance_minuten; const dayFormatted = ('0' + day).slice(-2); const dayName = ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"][dayOfWeek]; let holidayMarker = ""; if (isFullHoliday) holidayMarker = "(FT)"; else if (isHalfHoliday && isWorkday) holidayMarker = "(HFT)"; dailyDetailsForPDF.push([ `${dayFormatted}. ${dayName} ${holidayMarker}`, shiftText, minutesToHHMM(dailyBalance_minuten), minutesToHHMM(runningBalancePDF) ]);
            }
            const veraenderung_minuten = gutschrift_gesamt_minuten - monatssoll_minuten; const endstand_minuten = startBalanceMinutes + veraenderung_minuten; const total_wd_credit = gutschrift_wd_f + gutschrift_wd_m1 + gutschrift_wd_s + gutschrift_wd_n; const total_weft_credit = gutschrift_weft_f + gutschrift_weft_m1 + gutschrift_weft_s + gutschrift_weft_n;
            const pageHeight = doc.internal.pageSize.height; const pageWidth = doc.internal.pageSize.width; const margin = 15; let yPos = margin;
            function addText(text, x = margin, isBold = false, fontSize = 10, align = 'left') { if (yPos + (fontSize * 0.35) > pageHeight - margin) { doc.addPage(); yPos = margin; addHeaderFooter(); } doc.setFontSize(fontSize); doc.setFont(undefined, isBold ? 'bold' : 'normal'); doc.text(text, x, yPos, { align: align }); yPos += (fontSize * 0.45); }
            function addLine(x1 = margin, x2 = pageWidth - margin) { if (yPos + 2 > pageHeight - margin) { doc.addPage(); yPos = margin; addHeaderFooter(); } doc.setDrawColor(200); doc.line(x1, yPos, x2, yPos); yPos += 3; }
            function addHeaderFooter() { const pageNum = doc.internal.getNumberOfPages(); doc.setFontSize(8); doc.setTextColor(150); doc.text(`Seite ${pageNum}`, pageWidth - margin, pageHeight - 10, { align: 'right' }); doc.text(`Stundenkonto ${monthNames[month]} ${year}${pageNum > 1 ? ' (Fortsetzung)' : ''}`, margin, 10); doc.setTextColor(0); }
            addHeaderFooter(); yPos = margin + 5; doc.setFontSize(16); doc.setFont(undefined, 'bold'); doc.text(`Stundenkonto Übersicht: ${monthNames[month]} ${year}`, pageWidth / 2, yPos, { align: 'center' }); yPos += 10;
            addText("Monatsbilanz", margin, true, 12); yPos += 2; addText(`Monatliches Soll: ${minutesToHHMM(monatssoll_minuten)} (${werktage_im_monat_fuer_soll_count.toFixed(1).replace('.0', '')} Tage)`); addText(`Monatliches Haben: ${minutesToHHMM(gutschrift_gesamt_minuten)}`); addText(`Veränderung Monat: ${minutesToHHMM(veraenderung_minuten)}`); yPos += 1; addText(`Neuer Kontostand: ${minutesToHHMM(endstand_minuten)}`, margin, true); yPos += 6; addLine();
            addText("Details", margin, true, 12); yPos += 2; addText(`AZK Vormonat: ${minutesToHHMM(startBalanceMinutes)}`); addText(`Arbeitspensum: ${prozent.toFixed(1)}%`); addText(`Persönliches Tagessoll: ${minutesToHHMM(tagessoll_minuten_full)}`); addText(`Urlaubstage (an Soll-Tagen): ${urlaub_tage_anzahl}`); addText(`Krankheitstage (an Soll-Tagen): ${krank_tage_anzahl}`); yPos += 3;
            addText(`Stundengutschrift Werktage (Mo-Fr, kein FT): ${minutesToHHMM(total_wd_credit)}`, margin, true); addText(`  Frühdienste: ${minutesToHHMM(gutschrift_wd_f)}`, margin + 5); addText(`  M1-Dienste: ${minutesToHHMM(gutschrift_wd_m1)}`, margin + 5); addText(`  Spätdienste: ${minutesToHHMM(gutschrift_wd_s)}`, margin + 5); addText(`  Nachtdienste: ${minutesToHHMM(gutschrift_wd_n)}`, margin + 5); yPos += 3;
            addText(`Stundengutschrift Feiertage & Wochenende: ${minutesToHHMM(total_weft_credit)}`, margin, true); addText(`  Frühdienste: ${minutesToHHMM(gutschrift_weft_f)}`, margin + 5); addText(`  M1-Dienste: ${minutesToHHMM(gutschrift_weft_m1)}`, margin + 5); addText(`  Spätdienste: ${minutesToHHMM(gutschrift_weft_s)}`, margin + 5); addText(`  Nachtdienste: ${minutesToHHMM(gutschrift_weft_n)}`, margin + 5); yPos += 8; addLine();
            addText("Tagesübersicht", margin, true, 12); yPos += 4;
            doc.autoTable({ head: [['Tag', 'Schicht', 'Tagessaldo (Δ)', 'Laufender Saldo (Σ)']], body: dailyDetailsForPDF, startY: yPos, theme: 'grid', headStyles: { fillColor: [220, 220, 220], textColor: 40, fontStyle: 'bold' }, styles: { fontSize: 9, cellPadding: 1.5 }, columnStyles: { 0: { cellWidth: 'auto' }, 1: { cellWidth: 'auto' }, 2: { cellWidth: 'auto', halign: 'right' }, 3: { cellWidth: 'auto', halign: 'right' } }, didDrawPage: (data) => { addHeaderFooter(); yPos = margin + 5; } });
            if (doc.lastAutoTable) { yPos = doc.lastAutoTable.finalY + 10; } if (yPos < pageHeight - 20) { addHeaderFooter(); }
            doc.save(`Stundenkonto_${year}_${('0' + (month + 1)).slice(-2)}.pdf`);
        }
        // --- Shift Text Helper ---
        function getShiftText(shiftType) { /* ... (no changes needed) ... */ switch(shiftType) { case 'f': return 'Früh'; case 'm1': return 'M1'; case 's': return 'Spät'; case 'n': return 'Nacht'; case 'urlaub': return 'Urlaub'; case 'frei': return 'Frei'; case 'krank': return 'Krank'; default: return '-'; } }

        // --- Clear Month ---
        function clearMonthEntries() { /* ... (no changes needed) ... */ const year = parseInt(yearSelect.value); const month = parseInt(monthSelect.value); const monthName = monthNames[month]; if (!confirm(`Sind Sie sicher, dass Sie alle Einträge für ${monthName} ${year} löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden.`)) { return; } const daysInMonth = new Date(year, month + 1, 0).getDate(); let entriesCleared = false; for (let day = 1; day <= daysInMonth; day++) { const dateStr = formatDate(new Date(year, month, day)); if (dailyData.hasOwnProperty(dateStr)) { delete dailyData[dateStr]; entriesCleared = true; } } if (entriesCleared) { console.log(`Alle Einträge für ${monthName} ${year} gelöscht.`); recalculateIfValid(); } else { console.log(`Keine Einträge für ${monthName} ${year} zum Löschen gefunden.`); } }

        // --- Start ---
        init();

    </script>

</body>
</html>
